!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("wcslight",[],e):"object"==typeof exports?exports.wcslight=e():t.wcslight=e()}(self,(()=>(()=>{var t,e,i={725:function(t,e,i){var s,r,n;n="undefined"!=typeof self&&self||"undefined"!=typeof window&&window||void 0!==i.g&&i.g||this,s=function(t){"use strict";var e=n.BlobBuilder||n.WebKitBlobBuilder||n.MSBlobBuilder||n.MozBlobBuilder,i=n.URL||n.webkitURL||function(t,e){return(e=document.createElement("a")).href=t,e},s=n.Blob,r=i.createObjectURL,a=i.revokeObjectURL,h=n.Symbol&&n.Symbol.toStringTag,o=!1,l=!1,d=e&&e.prototype.append&&e.prototype.getBlob;try{o=2===new Blob(["Ã¤"]).size,l=2===new Blob([new Uint8Array([1,2])]).size}catch(t){}function c(t){return t.map((function(t){if(t.buffer instanceof ArrayBuffer){var e=t.buffer;if(t.byteLength!==e.byteLength){var i=new Uint8Array(t.byteLength);i.set(new Uint8Array(e,t.byteOffset,t.byteLength)),e=i.buffer}return e}return t}))}function f(t,i){i=i||{};var s=new e;return c(t).forEach((function(t){s.append(t)})),i.type?s.getBlob(i.type):s.getBlob()}function p(t,e){return new s(c(t),e||{})}n.Blob&&(f.prototype=Blob.prototype,p.prototype=Blob.prototype);var u="function"==typeof TextEncoder?TextEncoder.prototype.encode.bind(new TextEncoder):function(t){for(var e=0,i=t.length,s=n.Uint8Array||Array,r=0,a=Math.max(32,i+(i>>1)+7),h=new s(a>>3<<3);e<i;){var o=t.charCodeAt(e++);if(o>=55296&&o<=56319){if(e<i){var l=t.charCodeAt(e);56320==(64512&l)&&(++e,o=((1023&o)<<10)+(1023&l)+65536)}if(o>=55296&&o<=56319)continue}if(r+4>h.length){a+=8,a=(a*=1+e/t.length*2)>>3<<3;var d=new Uint8Array(a);d.set(h),h=d}if(0!=(4294967168&o)){if(0==(4294965248&o))h[r++]=o>>6&31|192;else if(0==(4294901760&o))h[r++]=o>>12&15|224,h[r++]=o>>6&63|128;else{if(0!=(4292870144&o))continue;h[r++]=o>>18&7|240,h[r++]=o>>12&63|128,h[r++]=o>>6&63|128}h[r++]=63&o|128}else h[r++]=o}return h.slice(0,r)},_="function"==typeof TextDecoder?TextDecoder.prototype.decode.bind(new TextDecoder):function(t){for(var e=t.length,i=[],s=0;s<e;){var r,n,a,h,o=t[s],l=null,d=o>239?4:o>223?3:o>191?2:1;if(s+d<=e)switch(d){case 1:o<128&&(l=o);break;case 2:128==(192&(r=t[s+1]))&&(h=(31&o)<<6|63&r)>127&&(l=h);break;case 3:r=t[s+1],n=t[s+2],128==(192&r)&&128==(192&n)&&(h=(15&o)<<12|(63&r)<<6|63&n)>2047&&(h<55296||h>57343)&&(l=h);break;case 4:r=t[s+1],n=t[s+2],a=t[s+3],128==(192&r)&&128==(192&n)&&128==(192&a)&&(h=(15&o)<<18|(63&r)<<12|(63&n)<<6|63&a)>65535&&h<1114112&&(l=h)}null===l?(l=65533,d=1):l>65535&&(l-=65536,i.push(l>>>10&1023|55296),l=56320|1023&l),i.push(l),s+=d}for(var c=i.length,f="",p=0;p<c;)f+=String.fromCharCode.apply(String,i.slice(p,p+=4096));return f};function m(){var e=!!n.ActiveXObject||"-ms-scroll-limit"in document.documentElement.style&&"-ms-ime-align"in document.documentElement.style,i=n.XMLHttpRequest&&n.XMLHttpRequest.prototype.send;e&&i&&(XMLHttpRequest.prototype.send=function(t){t instanceof Blob?(this.setRequestHeader("Content-Type",t.type),i.call(this,t)):i.call(this,t)});try{new File([],""),t.File=n.File,t.FileReader=n.FileReader}catch(e){try{t.File=new Function('class File extends Blob {constructor(chunks, name, opts) {opts = opts || {};super(chunks, opts || {});this.name = name.replace(/\\//g, ":");this.lastModifiedDate = opts.lastModified ? new Date(opts.lastModified) : new Date();this.lastModified = +this.lastModifiedDate;}};return new File([], ""), File')()}catch(e){t.File=function(t,e,i){var s=new Blob(t,i),r=i&&void 0!==i.lastModified?new Date(i.lastModified):new Date;return s.name=e.replace(/\//g,":"),s.lastModifiedDate=r,s.lastModified=+r,s.toString=function(){return"[object File]"},h&&(s[h]="File"),s}}}}o?(m(),t.Blob=l?n.Blob:p):d?(m(),t.Blob=f):function(){function e(t){for(var e=new Array(t.byteLength),i=new Uint8Array(t),s=e.length;s--;)e[s]=i[s];return e}function s(t){for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",i=[],s=0;s<t.length;s+=3){var r=t[s],n=s+1<t.length,a=n?t[s+1]:0,h=s+2<t.length,o=h?t[s+2]:0,l=r>>2,d=(3&r)<<4|a>>4,c=(15&a)<<2|o>>6,f=63&o;h||(f=64,n||(c=64)),i.push(e[l],e[d],e[c],e[f])}return i.join("")}var h=Object.create||function(t){function e(){}return e.prototype=t,new e};function o(t){return Object.prototype.toString.call(t).slice(8,-1)}function l(t,e){return"object"==typeof t&&Object.prototype.isPrototypeOf.call(t.prototype,e)}var d=["Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array","ArrayBuffer"];function c(t){return e=d,i=o(t),-1!==e.indexOf(i)||l(n.ArrayBuffer,t);var e,i}function f(t,i){i=null==i?{}:i;for(var s=0,r=(t=t?t.slice():[]).length;s<r;s++){var a=t[s];a instanceof f?t[s]=a._buffer:"string"==typeof a?t[s]=u(a):"DataView"===o(h=a)||l(n.DataView,h)?t[s]=e(a.buffer):c(a)?t[s]=e(a):t[s]=u(String(a))}var h;this._buffer=n.Uint8Array?function(t){for(var e=0,i=t.length;i--;)e+=t[i].length;for(var s=new Uint8Array(e),r=0,n=0;n<t.length;n++){var a=t[n];s.set(a,r),r+=a.byteLength||a.length}return s}(t):[].concat.apply([],t),this.size=this._buffer.length,this.type=i.type||"",/[^\u0020-\u007E]/.test(this.type)?this.type="":this.type=this.type.toLowerCase()}function p(t,e,i){i=i||{};var s=f.call(this,t,i)||this;return s.name=e.replace(/\//g,":"),s.lastModifiedDate=i.lastModified?new Date(i.lastModified):new Date,s.lastModified=+s.lastModifiedDate,s}if(f.prototype.arrayBuffer=function(){return Promise.resolve(this._buffer.buffer||this._buffer)},f.prototype.text=function(){return Promise.resolve(_(this._buffer))},f.prototype.slice=function(t,e,i){return new f([this._buffer.slice(t||0,e||this._buffer.length)],{type:i})},f.prototype.toString=function(){return"[object Blob]"},p.prototype=h(f.prototype),p.prototype.constructor=p,Object.setPrototypeOf)Object.setPrototypeOf(p,f);else try{p.__proto__=f}catch(t){}function m(){if(!(this instanceof m))throw new TypeError("Failed to construct 'FileReader': Please use the 'new' operator, this DOM object constructor cannot be called as a function.");var t=document.createDocumentFragment();this.addEventListener=t.addEventListener,this.dispatchEvent=function(e){var i=this["on"+e.type];"function"==typeof i&&i(e),t.dispatchEvent(e)},this.removeEventListener=t.removeEventListener}function g(t,e,i){if(!(e instanceof f))throw new TypeError("Failed to execute '"+i+"' on 'FileReader': parameter 1 is not of type 'Blob'.");t.result="",setTimeout((function(){this.readyState=m.LOADING,t.dispatchEvent(new Event("load")),t.dispatchEvent(new Event("loadend"))}))}p.prototype.toString=function(){return"[object File]"},m.EMPTY=0,m.LOADING=1,m.DONE=2,m.prototype.error=null,m.prototype.onabort=null,m.prototype.onerror=null,m.prototype.onload=null,m.prototype.onloadend=null,m.prototype.onloadstart=null,m.prototype.onprogress=null,m.prototype.readAsDataURL=function(t){g(this,t,"readAsDataURL"),this.result="data:"+t.type+";base64,"+s(t._buffer)},m.prototype.readAsText=function(t){g(this,t,"readAsText"),this.result=_(t._buffer)},m.prototype.readAsArrayBuffer=function(t){g(this,t,"readAsText"),this.result=(t._buffer.buffer||t._buffer).slice()},m.prototype.abort=function(){},i.createObjectURL=function(t){return t instanceof f?"data:"+t.type+";base64,"+s(t._buffer):r.call(i,t)},i.revokeObjectURL=function(t){a&&a.call(i,t)};var I=n.XMLHttpRequest&&n.XMLHttpRequest.prototype.send;I&&(XMLHttpRequest.prototype.send=function(t){t instanceof f?(this.setRequestHeader("Content-Type",t.type),I.call(this,_(t._buffer))):I.call(this,t)}),t.Blob=f,t.File=p,t.FileReader=m,t.URL=i}(),h&&(t.File.prototype[h]||(t.File.prototype[h]="File"),t.Blob.prototype[h]||(t.Blob.prototype[h]="Blob"),t.FileReader.prototype[h]||(t.FileReader.prototype[h]="FileReader"));var g,I=t.Blob.prototype;try{new ReadableStream({type:"bytes"}),g=function(){var t=0,e=this;return new ReadableStream({type:"bytes",autoAllocateChunkSize:524288,pull:function(i){var s=i.byobRequest.view;return e.slice(t,t+s.byteLength).arrayBuffer().then((function(r){var n=new Uint8Array(r),a=n.byteLength;t+=a,s.set(n),i.byobRequest.respond(a),t>=e.size&&i.close()}))}})}}catch(t){try{new ReadableStream({}),g=function(t){var e=0;return new ReadableStream({pull:function(i){return t.slice(e,e+524288).arrayBuffer().then((function(s){e+=s.byteLength;var r=new Uint8Array(s);i.enqueue(r),e==t.size&&i.close()}))}})}}catch(t){try{new Response("").body.getReader().read(),g=function(){return new Response(this).body}}catch(t){g=function(){throw new Error("Include https://github.com/MattiasBuelens/web-streams-polyfill")}}}}function w(t){return new Promise((function(e,i){t.onload=t.onerror=function(s){t.onload=t.onerror=null,"load"===s.type?e(t.result||t):i(new Error("Failed to read the blob/file"))}}))}I.arrayBuffer||(I.arrayBuffer=function(){var t=new FileReader;return t.readAsArrayBuffer(this),w(t)}),I.text||(I.text=function(){var t=new FileReader;return t.readAsText(this),w(t)}),I.stream||(I.stream=g)},void 0===(r=s.apply(e,[e]))||(t.exports=r)},682:()=>{}},s={};function r(t){var e=s[t];if(void 0!==e)return e.exports;var n=s[t]={exports:{}};return i[t].call(n.exports,n,n.exports,r),n.exports}r.m=i,r.d=(t,e)=>{for(var i in e)r.o(e,i)&&!r.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},r.f={},r.e=t=>Promise.all(Object.keys(r.f).reduce(((e,i)=>(r.f[i](t,e),e)),[])),r.u=t=>t+".js",r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),r.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),t={},e="wcslight:",r.l=(i,s,n,a)=>{if(t[i])t[i].push(s);else{var h,o;if(void 0!==n)for(var l=document.getElementsByTagName("script"),d=0;d<l.length;d++){var c=l[d];if(c.getAttribute("src")==i||c.getAttribute("data-webpack")==e+n){h=c;break}}h||(o=!0,(h=document.createElement("script")).charset="utf-8",h.timeout=120,r.nc&&h.setAttribute("nonce",r.nc),h.setAttribute("data-webpack",e+n),h.src=i),t[i]=[s];var f=(e,s)=>{h.onerror=h.onload=null,clearTimeout(p);var r=t[i];if(delete t[i],h.parentNode&&h.parentNode.removeChild(h),r&&r.forEach((t=>t(s))),e)return e(s)},p=setTimeout(f.bind(null,void 0,{type:"timeout",target:h}),12e4);h.onerror=f.bind(null,h.onerror),h.onload=f.bind(null,h.onload),o&&document.head.appendChild(h)}},r.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},(()=>{var t;r.g.importScripts&&(t=r.g.location+"");var e=r.g.document;if(!t&&e&&(e.currentScript&&(t=e.currentScript.src),!t)){var i=e.getElementsByTagName("script");i.length&&(t=i[i.length-1].src)}if(!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),r.p=t})(),(()=>{var t={499:0,190:0};r.f.j=(e,i)=>{var s=r.o(t,e)?t[e]:void 0;if(0!==s)if(s)i.push(s[2]);else{var n=new Promise(((i,r)=>s=t[e]=[i,r]));i.push(s[2]=n);var a=r.p+r.u(e),h=new Error;r.l(a,(i=>{if(r.o(t,e)&&(0!==(s=t[e])&&(t[e]=void 0),s)){var n=i&&("load"===i.type?"missing":i.type),a=i&&i.target&&i.target.src;h.message="Loading chunk "+e+" failed.\n("+n+": "+a+")",h.name="ChunkLoadError",h.type=n,h.request=a,s[1](h)}}),"chunk-"+e,e)}};var e=(e,i)=>{var s,n,[a,h,o]=i,l=0;if(a.some((e=>0!==t[e]))){for(s in h)r.o(h,s)&&(r.m[s]=h[s]);o&&o(r)}for(e&&e(i);l<a.length;l++)n=a[l],r.o(t,n)&&t[n]&&t[n][0](),t[n]=0},i=self.webpackChunkwcslight=self.webpackChunkwcslight||[];i.forEach(e.bind(null,0)),i.push=e.bind(null,i.push.bind(i))})();var n={};return(()=>{"use strict";r.r(n),r.d(n,{AbstractProjection:()=>k,CoordsType:()=>d,GnomonicProjection:()=>W,HEALPixProjection:()=>q,HiPSHelper:()=>j,HiPSProjection:()=>U,ImagePixel:()=>p,MercatorProjection:()=>S,NumberType:()=>l,Point:()=>T,TestProj:()=>G,WCSLight:()=>Z,astroToSpherical:()=>m,cartesianToSpherical:()=>u,degToRad:()=>y,fillAstro:()=>I,fillSpherical:()=>w,radToDeg:()=>A,sphericalToAstro:()=>_,sphericalToCartesian:()=>g});class t{constructor(t,e,i){this._key=void 0!==t?t:void 0,this._value=void 0!==e?e:void 0,this._comment=void 0!==i?i:void 0}get key(){return this._key}get comment(){return this._comment}get value(){return this._value}}class e extends Map{constructor(){super(),this._offset=void 0,this._items=[]}set offset(t){this._offset=t}get offset(){return this._offset}getItemList(){return this._items}getItemListOf(t){const e=[];for(let i=0;i<this._items.length;i++){const s=this._items[i];s.key==t&&e.push(s)}return e}addItemAtTheBeginning(t){void 0!==t.key&&["SIMPLE","BITPIX","NAXIS","NAXIS1","NAXIS2","BLANK","BZERO","BSCALE","DATAMIN","DATAMAX","NPIX","ORDER","CRPIX1","CRPIX2","CDELT1","CDELT2"].includes(t.key)&&this.set(t.key,t.value);const e=[t].concat(this._items);this._items=e}addItem(t){void 0!==t.key&&["SIMPLE","BITPIX","NAXIS","NAXIS1","NAXIS2","BLANK","BZERO","BSCALE","DATAMIN","DATAMAX","NPIX","ORDER","CRPIX1","CRPIX2","CDELT1","CDELT2"].includes(t.key)&&this.set(t.key,t.value),this._items.push(t)}getNumRows(){return this._items.length}}var i=r(725);class s{static getStringAt(t,e,i){const s=[];for(let r=e,n=0;r<e+i;r++,n++)s[n]=String.fromCharCode(255&t.charCodeAt(r));return s.join("")}static byteString(t){if(t<0||t>255||t%1!=0)throw new Error(t+" does not fit in a byte");return("000000000"+t.toString(2)).substr(-8)}static parse32bitSinglePrecisionFloatingPoint(t,e,i,s){let r=(((t<<8)+e<<8)+i<<8)+s;return r<0&&(r+=4294967296),(1+(8388607&r)/8388608)*Math.pow(2,((2139095040&r)>>23)-127)}static convertBlankToBytes(t,e){let i=Math.abs(t).toString(2);for(;i.length/8<e;)i+="0";const s=new ArrayBuffer(e),r=new Uint8Array(s);for(let t=0;t<e;t++)r[t]=parseInt(i.substr(8*t,8*(t+1)),2);return r}static parseFloatingPointFormat(t,e,i){const s=[];for(let e=t.length;e;e-=1){let i=t[e-1];for(let t=8;t;t-=1)s.push(i%2?1:0),i>>=1}s.reverse();const r=s.join(""),n=(1<<e-1)-1,a=parseInt(r.substring(0,1),2)?-1:1,h=parseInt(r.substring(1,1+e),2),o=parseInt(r.substring(1+e),2);return h===(1<<e)-1?0!==o?void 0:a*(1/0):h>0?a*Math.pow(2,h-n)*(1+o/Math.pow(2,i)):0!==o?a*Math.pow(2,-(n-1))*(o/Math.pow(2,i)):0*a}static generate16bit2sComplement(t){throw new TypeError("not implemented yet"+t)}static parse16bit2sComplement(t,e){const i=t<<8|e;return 32768&i?4294901760|i:i}static parse32bit2sComplement(t,e,i,s){const r=t<<24|e<<16|i<<8|s;let n=4294967295&r;return(2147483648&r)>>31?(n=1+(4294967295&~r),-1*n):n}static getByteAt(t,e){return 255&t.charCodeAt(e+0)}static extractPixelValue(t,e,i){let r;if(8==i)r=e[0];else if(16==i)r=s.parse16bit2sComplement(e[t],e[t+1]);else if(32==i)r=s.parse32bit2sComplement(e[t],e[t+1],e[t+2],e[t+3]);else if(-32==i)r=s.parseFloatingPointFormat(e.slice(t,t+8),8,23);else{if(64==i)throw new Error("BITPIX=64 -> 64-bit 2's complement binary integer NOT supported yet.");-64==i&&(r=s.parseFloatingPointFormat(e.slice(t,t+8),11,52))}return r}}class a{constructor(){this._headerArray=new Uint8Array,this._payloadArray=new Array,this._fitsData=new Uint8Array}run(t,e){this.prepareHeader(t),this._payloadArray=e,this.prepareFITS()}prepareHeader(e){const i=new t("END");e.addItem(i);let r="";for(let t=0;t<e.getItemList().length;t++){const i=e.getItemList()[t];let s=this.formatHeaderLine(i);void 0!==s&&(r+=s)}const n=(new TextEncoder).encode(r).length,a=2880*Math.ceil(n/2880);for(let t=0;t<a-n;t++)r+=" ";const h=new ArrayBuffer(r.length);this._headerArray=new Uint8Array(h);for(let t=0;t<r.length;t++)this._headerArray[t]=s.getByteAt(r,t)}formatHeaderLine(t){let e,i=t.key,s=t.value,r=t.comment;if(null!=i){if(e=i,"END"==i){for(let t=80;t>i.length;t--)e+=" ";return e}if("COMMENT"==i||"HISTORY"==i){for(let t=0;t<10-i.length;t++)e+=" ";e+=s;const t=e.length;for(let i=80;i>t;i--)e+=" ";return e}for(let t=0;t<8-i.length;t++)e+=" ";if(e+="= ",null!=s){e+=s,null!=r&&(e+=r);const t=e.length;for(let i=80;i>t;i--)e+=" "}else{null!=r&&(e+=r);const t=e.length;for(let i=80;i>t;i--)e+=" "}}else{e="";for(let t=0;t<18;t++)e+=" ";if(null!=r){e+=r;const t=e.length;for(let i=80;i>t;i--)e+=" "}else{e="";for(let t=80;t>0;t--)e+=" "}}return e}prepareFITS(){const t=new Uint8Array(this._headerArray.length+this._payloadArray[0].length*this._payloadArray.length);t.set(this._headerArray,0);for(let e=0;e<this._payloadArray.length;e++){const i=this._payloadArray[e];t.set(i,this._headerArray.length+e*i.length)}this._fitsData=t}typedArrayToURL(){const t=new i.Blob([this._fitsData],{type:"application/fits"});return URL.createObjectURL(t)}}class h{constructor(t,e){this._u8data=new Uint8Array,this._BZERO=void 0,this._BSCALE=void 0,this._BLANK=void 0,this._BITPIX=void 0,this._NAXIS1=void 0,this._NAXIS2=void 0,this._DATAMIN=void 0,this._DATAMAX=void 0,this._physicalblank=void 0;const i=e.slice(t.offset);this._u8data=new Uint8Array(i),this.init(t)}init(e){if(this._BZERO=e.get("BZERO"),void 0===this._BZERO&&(this._BZERO=0),this._BSCALE=e.get("BSCALE"),void 0===this._BSCALE&&(this._BSCALE=1),this._BLANK=e.get("BLANK"),this._BITPIX=e.get("BITPIX"),this._NAXIS1=e.get("NAXIS1"),this._NAXIS2=e.get("NAXIS2"),this._DATAMIN=e.get("DATAMIN"),this._DATAMAX=e.get("DATAMAX"),this._physicalblank=void 0,void 0===this._DATAMAX||void 0===this._DATAMIN){const[i,s]=this.computePhysicalMinAndMax();this._DATAMAX=s,this._DATAMIN=i;const r=new t("DATAMAX",s," / computed with FITSParser"),n=new t("DATAMIN",i," / computed with FITSParser");e.addItem(r),e.addItem(n)}}computePhysicalMinAndMax(){let t=0;if(void 0===this._BITPIX)throw new Error("BITPIX is not defined");const e=Math.abs(this._BITPIX/8),i=this._u8data.byteLength/e;let s,r,n,a;for(void 0!==this._BLANK&&(this._physicalblank=this.pixel2physicalValue(this._BLANK));t<i;)s=this.extractPixelValue(e*t),void 0!==s?(r=this.pixel2physicalValue(s),void 0===n&&(n=r),void 0===a&&(a=r),void 0!==this._physicalblank&&this._physicalblank===r||(void 0!==r&&(r<n||void 0===n)&&(n=r),void 0!==r&&(r>a||void 0===a)&&(a=r)),t++):t++;return[n,a]}parse(){if(void 0===this._BITPIX)throw new Error("BITPIX is undefined");if(void 0===this._NAXIS1)throw new Error("NAXIS1 is undefined");if(void 0===this._NAXIS2)throw new Error("NAXIS2 is undefined");const t=Math.abs(this._BITPIX/8);let e=this._u8data.byteLength/t;e=this._NAXIS1*this._NAXIS2;let i,s,r=0;const n=[];for(;r<e;){s=Math.floor(r/this._NAXIS1),i=(r-s*this._NAXIS1)*t,0===i&&(n[s]=new Uint8Array(this._NAXIS1*t));for(let e=0;e<t;e++)n[s][i+e]=this._u8data[r*t+e];r++}return n}extractPixelValue(t){let e;if(16==this._BITPIX)e=s.parse16bit2sComplement(this._u8data[t],this._u8data[t+1]);else if(32==this._BITPIX)e=s.parse32bit2sComplement(this._u8data[t],this._u8data[t+1],this._u8data[t+2],this._u8data[t+3]);else if(-32==this._BITPIX)e=s.parseFloatingPointFormat(this._u8data.slice(t,t+4),8,23);else{if(64==this._BITPIX)throw new Error("BITPIX=64 -> 64-bit 2's complement binary integer NOT supported yet.");-64==this._BITPIX&&(e=s.parseFloatingPointFormat(this._u8data.slice(t,t+8),11,52))}return e}pixel2physicalValue(t){if(void 0===this._BZERO||void 0===this._BSCALE)throw new Error("Either BZERO or BSCALE is undefined");return this._BZERO+this._BSCALE*t}}class o{static parse(i){const s=new TextDecoder("iso-8859-1"),r=new e;let n,a,h,l,d,c,f,p=0,u="";for(c=null;"END"!==u&&i.length>0;){if(a=new Uint8Array(i.slice(80*p,80*p+80)),p++,h=new Uint8Array(a.slice(0,8)),u=s.decode(h).trim(),d=new Uint8Array(a.slice(8,10)),l=new Uint8Array(a.slice(10,80)),n=s.decode(l).trim(),61==d[0]&&32==d[1]){let e=32;for(let t=0;t<l.length;t++)if(32!=l[t]){e=l[t];break}39!=e&&Number(n)?84==e||70==e?f=o.parseLogicalValue(l):(n=s.decode(l).trim(),f=n.includes(".")?o.parseFloatValue(l):o.parseIntValue(l)):f=o.parseStringValue(l),c=new t(u,f.val,f.comment)}else if("COMMENT"==u||"HISTORY"==u)c=new t(u,void 0,n);else{let e=32;for(let t=0;t<l.length;t++)if(32!=l[t]){e=l[t];break}47==e?c=new t(void 0,void 0,n):32==e&&(c=new t(void 0,void 0,void 0))}null!=c&&r.addItem(c)}c=new t("COMMENT","FITS generated with FITSParser on ",void 0),r.addItem(c);const _=new Date;c=new t("COMMENT",_.toString()),r.addItem(c);const m=2880*Math.ceil(p/36);return r.offset=m,r}static parseStringValue(t){const e=new TextDecoder("iso-8859-1").decode(t).trim(),i=e.lastIndexOf("/");return{val:e.substring(0,i),comment:e.substring(i)}}static parseLogicalValue(t){const e=new TextDecoder("iso-8859-1").decode(t).trim().split("/");return void 0===e[1]?{val:e[0].trim(),comment:void 0}:{val:e[0].trim(),comment:" /"+e[1]}}static parseIntValue(t){const e=new TextDecoder("iso-8859-1").decode(t).trim().split("/");return void 0===e[1]?{val:parseInt(e[0].trim()),comment:void 0}:{val:parseInt(e[0].trim()),comment:" /"+e[1]}}static parseFloatValue(t){const e=new TextDecoder("iso-8859-1").decode(t).trim().split("/");return void 0===e[1]?{val:parseFloat(e[0].trim()),comment:void 0}:{val:parseFloat(e[0].trim()),comment:" /"+e[1]}}}var l,d,c=function(t,e,i,s){return new(i||(i=Promise))((function(r,n){function a(t){try{o(s.next(t))}catch(t){n(t)}}function h(t){try{o(s.throw(t))}catch(t){n(t)}}function o(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,h)}o((s=s.apply(t,e||[])).next())}))};class f{constructor(t){this._url=t}loadFITS(){return c(this,void 0,void 0,(function*(){return this.getFile(this._url).then((t=>{if(null!==t&&t.byteLength>0){const e=new Uint8Array(t);return this.processFits(e)}return null})).catch((t=>{var e,i;if(null===(i=null===(e=null==t?void 0:t.response)||void 0===e?void 0:e.data)||void 0===i?void 0:i.message)throw new Error("[FITSParser->loadFITS] "+t.response.data.message);throw t}))}))}processFits(t){const e=o.parse(t);return{header:e,data:new h(e,t).parse()}}static generateFITS(t,e){const i=new a;return i.run(t,e),i.typedArrayToURL()}getFile(t){return c(this,void 0,void 0,(function*(){if(t.substring(0,5).toLowerCase().includes("http"))return(yield r.e(604).then(r.bind(r,604))).getFile(t).then((t=>t)).catch((t=>null));{let e=yield r.e(959).then(r.bind(r,959));return yield e.getLocalFile(t)}}))}}class p{constructor(t=null,e=null,i=null){this._i=t,this._j=e,this._tileno=i}geti(){return this._i}getj(){return this._j}get tileno(){return this._tileno}}function u(t){let e=(s=t,(i=t).x*s.x+i.y*s.y+i.z*s.z);var i,s;let r=Math.sqrt(e),n=Math.acos(t[2]/r),a=A(n),h=Math.atan2(t[1],t[0]),o=A(h);return o<0&&(o+=360),{phiDeg:o,thetaDeg:a,phiRad:h,thetaRad:n}}function _(t){let e,i;return e=t.phiDeg,e<0&&(e+=360),i=90-t.thetaDeg,{raDeg:e,decDeg:i,raRad:y(e),decRad:y(i)}}function m(t){let e,i;return e=t.raDeg,e<0&&(e+=360),i=90-t.decDeg,{phiDeg:e,thetaDeg:i,phiRad:y(e),thetaRad:y(i)}}function g(t,e){return{x:(e=null==e?1:e)*Math.sin(t.thetaRad)*Math.cos(t.phiRad),y:e*Math.sin(t.thetaRad)*Math.sin(t.phiRad),z:e*Math.cos(t.thetaRad)}}function I(t,e,i){return i==l.DEGREES?{raDeg:t,decDeg:e,raRad:y(t),decRad:y(e)}:i==l.RADIANS?{raRad:t,decRad:e,raDeg:A(t),decDeg:A(e)}:void console.error("Wrong operation. NumberType "+i+" not supported")}function w(t,e,i){return i==l.DEGREES?{phiDeg:t,thetaDeg:e,phiRad:y(t),thetaRad:y(e)}:i==l.RADIANS?{phiDeg:A(t),thetaDeg:A(e),phiRad:t,thetaRad:e}:void console.error("Wrong operation. NumberType "+i+" not supported")}function y(t){return t/180*Math.PI}function A(t){return 180*t/Math.PI}!function(t){t[t.DEGREES=0]="DEGREES",t[t.RADIANS=1]="RADIANS",t[t.DECIMAL=2]="DECIMAL",t[t.HMS=3]="HMS",t[t.DMS=4]="DMS"}(l||(l={})),function(t){t.CARTESIAN="cartesian",t.SPHERICAL="spherical",t.ASTRO="astro"}(d||(d={}));var v,x,M,E=function(t,e,i,s){if("a"===i&&!s)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!s:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?s:"a"===i?s.call(t):s?s.value:e.get(t)},P=function(t,e,i,s,r){if("m"===s)throw new TypeError("Private method is not writable");if("a"===s&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!r:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===s?r.call(t,i):r?r.value=i:e.set(t,i),i};class T{constructor(t,e,...i){v.set(this,void 0),x.set(this,void 0),M.set(this,void 0),t==d.CARTESIAN?(E(this,M,"f").x=parseFloat(i[0].toFixed(r.g.MAX_DECIMALS)),E(this,M,"f").y=parseFloat(i[1].toFixed(r.g.MAX_DECIMALS)),E(this,M,"f").z=parseFloat(i[2].toFixed(r.g.MAX_DECIMALS)),P(this,x,u(E(this,M,"f")),"f"),P(this,v,_(E(this,x,"f")),"f")):t==d.ASTRO?(P(this,v,I(i[0],i[1],e),"f"),P(this,x,m(E(this,v,"f")),"f"),P(this,M,g(E(this,x,"f"),1),"f")):t==d.SPHERICAL?(P(this,x,w(i[0],i[1],e),"f"),P(this,M,g(E(this,x,"f"),1),"f"),P(this,v,_(E(this,x,"f")),"f")):console.error("CoordsType "+t+" not recognised."),E(this,x,"f").phiDeg>360&&(E(this,x,"f").phiDeg-=360),E(this,v,"f").raDeg>360&&(E(this,v,"f").raDeg-=360)}get spherical(){return E(this,x,"f")}get astro(){return E(this,v,"f")}get cartesian(){return E(this,M,"f")}}v=new WeakMap,x=new WeakMap,M=new WeakMap,r(682);var b=function(t,e,i,s){return new(i||(i=Promise))((function(r,n){function a(t){try{o(s.next(t))}catch(t){n(t)}}function h(t){try{o(s.throw(t))}catch(t){n(t)}}function o(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,h)}o((s=s.apply(t,e||[])).next())}))};class S{constructor(){this._wcsname="MER",this._ctype1="RA---MER",this._ctype2="DEC--MER",this._pxvalues=new Map,this._fitsheader=new Array}initFromFile(t){return b(this,void 0,void 0,(function*(){let e=new f(t);this._infile=t,this._fitsUsed.push(t);let i=e.loadFITS().then((t=>{this._pxvalues.set(0,t.data),this._fitsheader[0]=t.header,this._naxis1=t.header.get("NAXIS1"),this._naxis2=t.header.get("NAXIS2"),this._craDeg=t.header.getItemListOf("CRVAL1")[0].value,this._cdecDeg=t.header.getItemListOf("CRVAL2")[0].value;const e=this._fitsheader[0].getItemListOf("CDELT1")[0].value,i=this._fitsheader[0].getItemListOf("CDELT2")[0].value;if(e!==i||void 0===e||void 0===i)throw new Error("pxsize1 is not equal to pxsize2");return this._pxsize=e,this._minra=this._craDeg-this._pxsize*this._naxis1/2,this._minra<0&&(this._minra+=360),this._mindec=this._cdecDeg-this._pxsize*this._naxis2/2,t}));return yield i,i}))}extractPhysicalValues(t){let e=t.header.get("BZERO"),i=t.header.get("BSCALE"),r=t.header.get("NAXIS1"),n=t.header.get("NAXIS2"),a=t.header.get("BITPIX"),h=Math.abs(a/8),o=(s.convertBlankToBytes(t.header.get("BLANK"),h),new Array(n));for(let l=0;l<n;l++){o[l]=new Array(r);for(let n=0;n<r;n++){let r=e+i*s.extractPixelValue(0,t.data[l].slice(n*h,(n+1)*h),a);o[l][n]=r}}return o}prepareFITSHeader(i){this._fitsheader[0]=new e,this._fitsheader[0].addItemAtTheBeginning(new t("BITPIX",i.get("BITPIX"))),this._fitsheader[0].addItemAtTheBeginning(new t("SIMPLE",i.get("SIMPLE"))),void 0!==i.get("BLANK")&&this._fitsheader[0].addItem(new t("BLANK",i.get("BLANK")));let s=1;void 0!==i.get("BSCALE")&&(s=i.get("BSCALE")),this._fitsheader[0].addItem(new t("BSCALE",s));let r=0;void 0!==i.get("BZERO")&&(r=i.get("BZERO")),this._fitsheader[0].addItem(new t("BZERO",r)),this._fitsheader[0].addItem(new t("NAXIS",2)),this._fitsheader[0].addItem(new t("NAXIS1",this._naxis1)),this._fitsheader[0].addItem(new t("NAXIS2",this._naxis2)),this._fitsheader[0].addItem(new t("CTYPE1",this._ctype1)),this._fitsheader[0].addItem(new t("CTYPE2",this._ctype2)),this._fitsheader[0].addItem(new t("CDELT1",this._pxsize)),this._fitsheader[0].addItem(new t("CDELT2",this._pxsize)),this._fitsheader[0].addItem(new t("CRPIX1",this._naxis1/2)),this._fitsheader[0].addItem(new t("CRPIX2",this._naxis2/2)),this._fitsheader[0].addItem(new t("CRVAL1",this._craDeg)),this._fitsheader[0].addItem(new t("CRVAL2",this._cdecDeg));let n=r+s*this._minphysicalval,a=r+s*this._maxphysicalval;return this._fitsheader[0].addItem(new t("DATAMIN",n)),this._fitsheader[0].addItem(new t("DATAMAX",a)),this._fitsheader[0].addItem(new t("ORIGIN","WCSLight v.0.x")),this._fitsheader[0].addItem(new t("COMMENT","WCSLight v0.x developed by F.Giordano and Y.Ascasibar")),this._fitsheader[0].addItem(new t("END")),this._fitsheader}getFITSHeader(){return this._fitsheader}getCommonFitsHeaderParams(){let i=new e;for(const[e,s]of this._fitsheader[0])["SIMPLE","BITPIX","BSCALE","BZERO","BLANK","ORDER"].includes(e)&&i.addItem(new t(e,s));return i}get fitsUsed(){return this._fitsUsed}getPixValues(t){return b(this,void 0,void 0,(function*(){return new Promise(((e,i)=>{try{let i=Math.abs(this._fitsheader[0].get("BITPIX")/8),r=s.convertBlankToBytes(this._fitsheader[0].get("BLANK"),i),n=t.length,a=new Uint8Array(n*i);for(let e=0;e<n;e++){let s=t[e];if(s._j<0||s._j>=this._naxis2||s._i<0||s._i>=this._naxis1)for(let t=0;t<i;t++)a[e*i+t]=r[t];else{let t=this._pxvalues.get(0);if(void 0!==t)for(let r=0;r<i;r++)a[e*i+r]=t[s._j][s._i*i+r]}}e(a)}catch(t){i("[MercatorProjection] ERROR: "+t)}}))}))}computeSquaredNaxes(t,e){this._naxis1=Math.ceil(t/e),this._naxis2=this._naxis1,this._pxsize=e}setPxsValue(t,e){let i=Math.abs(e.get("BITPIX")/8),r=s.extractPixelValue(0,t.slice(0,i),e.get("BITPIX")),n=r,a=void 0!==e.get("BSCALE")?e.get("BSCALE"):1,h=void 0!==e.get("BZERO")?e.get("BZERO"):0;this._minphysicalval=h+a*r,this._maxphysicalval=h+a*n,this._pxvalues.set(0,new Array(this._naxis2));let o=this._pxvalues.get(0);if(void 0!==o){for(let t=0;t<this._naxis2;t++)o[t]=new Uint8Array(this._naxis1*i);let r,n,l;for(let d=0;d*i<t.length;d++)try{for(r=Math.floor(d/this._naxis1),n=(d-r*this._naxis1)*i,l=0;l<i;l++)o[r][n+l]=t[d*i+l];let c=h+a*s.extractPixelValue(0,t.slice(d*i,d*i+i),e.get("BITPIX"));c<this._minphysicalval||isNaN(this._minphysicalval)?this._minphysicalval=c:(c>this._maxphysicalval||isNaN(this._maxphysicalval))&&(this._maxphysicalval=c)}catch(e){console.log(e),console.log("p "+d),console.log("r %, c %, b %"+r,n,l),console.log("this._pxvalues[r][c + b] "+o[r][n+l]),console.log("values[p * bytesXelem + b] "+t[d*i+l])}}return this.prepareFITSHeader(e),this._pxvalues}getImageRADecList(t,e,i){this.computeSquaredNaxes(2*e,i),this._pxsize=i,this._minra=t.astro.raDeg-e,this._minra<0&&(this._minra+=360),this._mindec=t.astro.decDeg-e;let s=new Array;for(let t=0;t<this._naxis2;t++)for(let e=0;e<this._naxis1;e++)s.push([this._minra+e*this._pxsize,this._mindec+t*this._pxsize]);let r=(this._naxis2/2-1)*this._naxis1+this._naxis1/2;return this._craDeg=s[r][0],this._cdecDeg=s[r][1],s}pix2world(t,e){let i,s;return i=t*this._pxsize+this._minra,s=e*this._pxsize+this._mindec,new T(d.ASTRO,l.DEGREES,i,s)}world2pix(t){let e=[];for(let i of t){let t=i[0],s=i[1],r=Math.floor((t-this._minra)/this._pxsize),n=Math.floor((s-this._mindec)/this._pxsize);e.push(new p(r,n))}return e}}class L{}L.halfpi=1.5707963267948966,L.inv_halfpi=2/Math.PI,L.twopi=2*Math.PI,L.inv_twopi=1/(2*Math.PI);class R{constructor(t,e){this.z=t,this.phi=e}}class D{constructor(t){D.PI4_A=.7853981554508209,D.PI4_B=7.946627356147928e-9,D.PI4_C=3061616997868383e-32,D.M_1_PI=.3183098861837907,t&&(this.sth=0,this.have_sth=!1,this.z=D.cos(t.theta),this._phi=t.phi,Math.abs(this.z)>.99&&(this.sth=D.sin(t.theta),this.have_sth=!0))}setZ(t){this.z=t}get phi(){return this._phi}set phi(t){this._phi=t}setSth(t){this.sth=t}toVec3(){var t=this.have_sth?this.sth:Math.sqrt((1-this.z)*(1+this.z));return new C(t*Math.cos(this.phi),t*Math.sin(this.phi),this.z)}toZphi(){return new R(this.z,this.phi)}static sin(t){let e=t*D.M_1_PI,i=Math.floor(e<0?e-.5:e+.5),s=4*i;return t-=s*D.PI4_A,t-=s*D.PI4_B,t-=s*D.PI4_C,0!=(1&i)&&(t=-t),this.sincoshelper(t)}static cos(t){let e=t*D.M_1_PI-.5,i=1+2*Math.floor(e<0?e-.5:e+.5),s=2*i;return t-=s*D.PI4_A,t-=s*D.PI4_B,t-=s*D.PI4_C,0==(2&i)&&(t=-t),D.sincoshelper(t)}static sincoshelper(t){let e=t*t,i=-7972559550090379e-33;return i=i*e+2810099727108632e-30,i=i*e-7647122191181588e-28,i=i*e+1.605904306056645e-10,i=i*e-2.5052108376350205e-8,i=i*e+27557319223919875e-22,i=i*e-.00019841269841269616,i=i*e+.00833333333333333,i=i*e-.16666666666666666,e*i*t+t}static asin(t){return D.mulsign(D.atan2k(Math.abs(t),Math.sqrt((1+t)*(1-t))),t)}static acos(t){return D.mulsign(D.atan2k(Math.sqrt((1+t)*(1-t)),Math.abs(t)),t)+(t<0?Math.PI:0)}static mulsign(t,e){return D.copySign(1,e)*t}static copySign(t,e){return e<0?-Math.abs(t):Math.abs(t)}static atanhelper(t){let e=t*t,i=-1887960084630735e-20;return i=i*e+.00020985007664581698,i=i*e-.0011061183148667248,i=i*e+.003700267441887131,i=i*e-.008898961958876555,i=i*e+.016599329773529202,i=i*e-.025451762493231264,i=i*e+.03378525800013531,i=i*e-.04076291912768365,i=i*e+.04666671500778406,i=i*e-.052367485230348246,i=i*e+.05876663929266736,i=i*e-.06665735793610805,i=i*e+.07692195383117696,i=i*e-.09090899500824501,i=i*e+.11111110564826142,i=i*e-.1428571426677133,i=i*e+.19999999999659127,i=i*e-.3333333333333111,i*e*t+t}static atan2k(t,e){let i=0;if(e<0&&(e=-e,i=-2),t>e){let s=e;e=t,t=-s,i+=1}return D.atanhelper(t/e)+i*(Math.PI/2)}static atan2(t,e){let i=D.atan2k(Math.abs(t),e);return i=D.mulsign(i,e),(D.isinf(e)||0==e)&&(i=Math.PI/2-(D.isinf(e)?D.copySign(1,e)*(Math.PI/2):0)),D.isinf(t)&&(i=Math.PI/2-(D.isinf(e)?D.copySign(1,e)*(1*Math.PI/4):0)),0==t&&(i=-1==D.copySign(1,e)?Math.PI:0),D.isnan(e)||D.isnan(t)?NaN:D.mulsign(i,t)}static isnan(t){return t!=t}static isinf(t){return Math.abs(t)===1/0}}D.PI4_A=.7853981554508209,D.PI4_B=7.946627356147928e-9,D.PI4_C=3061616997868383e-32,D.M_1_PI=.3183098861837907;class B{constructor(t,e,i,s){null!=t?(this.theta=D.atan2(Math.sqrt(t.x*t.x+t.y*t.y),t.z),this.phi=e?-D.atan2(t.y,t.x):D.atan2(t.y,t.x),this.phi<0&&(this.phi=this.phi+2*Math.PI),this.phi>=2*Math.PI&&(this.phi=this.phi-2*Math.PI)):(this.theta=i,this.phi=s)}}class C{constructor(t,e,i){if(t instanceof B){let e=t,i=D.sin(e.theta);this.x=i*D.cos(e.phi),this.y=i*D.sin(e.phi),this.z=D.cos(e.theta)}else this.x=t,this.y=e,this.z=i}getX(){return this.x}getY(){return this.y}getZ(){return this.z}scale(t){this.x*=t,this.y*=t,this.z*=t}cross(t){return new C(this.y*t.z-t.y*this.z,this.z*t.x-t.z*this.x,this.x*t.y-t.x*this.y)}add(t){return new C(this.x+t.x,this.y+t.y,this.z+t.z)}normalize(){let t=1/this.length();this.x*=t,this.y*=t,this.z*=t}norm(){let t=1/this.length();return new C(this.x*t,this.y*t,this.z*t)}length(){return Math.sqrt(this.lengthSquared())}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}sub(t){return new C(this.x-t.x,this.y-t.y,this.z-t.z)}angle(t){return D.atan2(this.cross(t).length(),this.dot(t))}flip(){this.x*=-1,this.y*=-1,this.z*=-1}static pointing2Vec3(t){let e=D.sin(t.theta),i=e*D.cos(t.phi),s=e*D.sin(t.phi),r=D.cos(t.theta);return new C(i,s,r)}}class N{constructor(t){let e=t.length;if(e>=2){this.center=t[0].add(t[1]),this.center.normalize(),this.cosrad=t[0].dot(this.center);for(let i=2;i<e;++i)t[i].dot(this.center)<this.cosrad&&this.getCircle(t,i)}else console.log("too few points")}getCircle(t,e){this.center=t[0].add(t[e]),this.center.normalize(),this.cosrad=t[0].dot(this.center);for(let i=1;i<e;++i)t[i].dot(this.center)<this.cosrad&&this.getCircle2(t,i,e)}getCircle2(t,e,i){this.center=t[e].add(t[i]),this.center.normalize(),this.cosrad=t[e].dot(this.center);for(let s=0;s<e;++s)t[s].dot(this.center)<this.cosrad&&(this.center=t[e].sub(t[s]).cross(t[i].sub(t[s])),this.center.normalize(),this.cosrad=t[s].dot(this.center),this.cosrad<0&&(this.center.flip(),this.cosrad=-this.cosrad))}getCenter(){return new C(this.center.x,this.center.y,this.center.z)}getCosrad(){return this.cosrad}}class O{constructor(t,e,i){this.fx=t,this.fy=e,this.face=i,this.jrll=new Uint8Array([2,2,2,2,3,3,3,3,4,4,4,4]),this.jpll=new Uint8Array([1,3,5,7,0,2,4,6,1,3,5,7]),this.halfpi=Math.PI/2}toHploc(){let t,e=new D,i=this.jrll[this.face]-this.fx-this.fy;if(i<1){t=i;let s=t*t/3;e.z=1-s,e.z>.99&&(e.sth=Math.sqrt(s*(2-s)),e.have_sth=!0)}else if(i>3){t=4-i;let s=t*t/3;e.z=s-1,e.z<-.99&&(e.sth=Math.sqrt(s*(2-s)),e.have_sth=!0)}else t=1,e.z=2*(2-i)/3;let s=this.jpll[this.face]*t+this.fx-this.fy;return s<0&&(s+=8),s>=8&&(s-=8),e.phi=t<1e-15?0:.5*this.halfpi*s/t,e}toVec3(){return this.toHploc().toVec3()}}class X{constructor(t){this.p=new Array(t),this.o=new Int32Array(t),this.s=0,this.m=0}push(t,e){this.p[this.s]=t,this.o[this.s]=e,++this.s}pop(){--this.s}popToMark(){this.s=this.m}size(){return this.s}mark(){this.m=this.s}otop(){return this.o[this.s-1]}ptop(){return this.p[this.s-1]}}class F{constructor(t){t<0&&console.error("capacity must be positive"),this.r=new Int32Array(t<<1),this.sz=0}append(t){this.append1(t,t+1)}append1(t,e){if(t>=e)return;if(this.sz>0&&t<=this.r[this.sz-1])return t<this.r[this.sz-2]&&console.error("bad append operation"),void(e>this.r[this.sz-1]&&(this.r[this.sz-1]=e));let i=this.sz+2;if(this.r.length<i){let t=Math.max(2*this.r.length,i),e=new Int32Array(t);e.set(this.r),this.r=e}this.r[this.sz]=t,this.r[this.sz+1]=e,this.sz+=2}ensureCapacity(t){this.r.length<t&&this.resize(Math.max(2*this.r.length,t))}resize(t){if(t<this.sz&&console.error("requested array size too small"),t==this.r.length)return;new Int32Array(t);let e=this.r.slice(0,this.sz+1);this.r=e}}class H{constructor(t,e,i){this.ix=t,this.iy=e,this.face=i}}class z{constructor(t){this.order_max=29,this.inv_halfpi=2/Math.PI,this.twothird=2/3,this.ns_max=Math.pow(2,this.order_max),this.ctab=new Uint16Array([0,1,256,257,2,3,258,259,512,513,768,769,514,515,770,771,4,5,260,261,6,7,262,263,516,517,772,773,518,519,774,775,1024,1025,1280,1281,1026,1027,1282,1283,1536,1537,1792,1793,1538,1539,1794,1795,1028,1029,1284,1285,1030,1031,1286,1287,1540,1541,1796,1797,1542,1543,1798,1799,8,9,264,265,10,11,266,267,520,521,776,777,522,523,778,779,12,13,268,269,14,15,270,271,524,525,780,781,526,527,782,783,1032,1033,1288,1289,1034,1035,1290,1291,1544,1545,1800,1801,1546,1547,1802,1803,1036,1037,1292,1293,1038,1039,1294,1295,1548,1549,1804,1805,1550,1551,1806,1807,2048,2049,2304,2305,2050,2051,2306,2307,2560,2561,2816,2817,2562,2563,2818,2819,2052,2053,2308,2309,2054,2055,2310,2311,2564,2565,2820,2821,2566,2567,2822,2823,3072,3073,3328,3329,3074,3075,3330,3331,3584,3585,3840,3841,3586,3587,3842,3843,3076,3077,3332,3333,3078,3079,3334,3335,3588,3589,3844,3845,3590,3591,3846,3847,2056,2057,2312,2313,2058,2059,2314,2315,2568,2569,2824,2825,2570,2571,2826,2827,2060,2061,2316,2317,2062,2063,2318,2319,2572,2573,2828,2829,2574,2575,2830,2831,3080,3081,3336,3337,3082,3083,3338,3339,3592,3593,3848,3849,3594,3595,3850,3851,3084,3085,3340,3341,3086,3087,3342,3343,3596,3597,3852,3853,3598,3599,3854,3855]),this.utab=new Uint16Array([0,1,4,5,16,17,20,21,64,65,68,69,80,81,84,85,256,257,260,261,272,273,276,277,320,321,324,325,336,337,340,341,1024,1025,1028,1029,1040,1041,1044,1045,1088,1089,1092,1093,1104,1105,1108,1109,1280,1281,1284,1285,1296,1297,1300,1301,1344,1345,1348,1349,1360,1361,1364,1365,4096,4097,4100,4101,4112,4113,4116,4117,4160,4161,4164,4165,4176,4177,4180,4181,4352,4353,4356,4357,4368,4369,4372,4373,4416,4417,4420,4421,4432,4433,4436,4437,5120,5121,5124,5125,5136,5137,5140,5141,5184,5185,5188,5189,5200,5201,5204,5205,5376,5377,5380,5381,5392,5393,5396,5397,5440,5441,5444,5445,5456,5457,5460,5461,16384,16385,16388,16389,16400,16401,16404,16405,16448,16449,16452,16453,16464,16465,16468,16469,16640,16641,16644,16645,16656,16657,16660,16661,16704,16705,16708,16709,16720,16721,16724,16725,17408,17409,17412,17413,17424,17425,17428,17429,17472,17473,17476,17477,17488,17489,17492,17493,17664,17665,17668,17669,17680,17681,17684,17685,17728,17729,17732,17733,17744,17745,17748,17749,20480,20481,20484,20485,20496,20497,20500,20501,20544,20545,20548,20549,20560,20561,20564,20565,20736,20737,20740,20741,20752,20753,20756,20757,20800,20801,20804,20805,20816,20817,20820,20821,21504,21505,21508,21509,21520,21521,21524,21525,21568,21569,21572,21573,21584,21585,21588,21589,21760,21761,21764,21765,21776,21777,21780,21781,21824,21825,21828,21829,21840,21841,21844,21845]),this.jrll=new Int16Array([2,2,2,2,3,3,3,3,4,4,4,4]),this.jpll=new Int16Array([1,3,5,7,0,2,4,6,1,3,5,7]),this.xoffset=new Int16Array([-1,-1,0,1,1,1,0,-1]),this.yoffset=new Int16Array([0,1,1,1,0,-1,-1,-1]),this.facearray=[new Int16Array([8,9,10,11,-1,-1,-1,-1,10,11,8,9]),new Int16Array([5,6,7,4,8,9,10,11,9,10,11,8]),new Int16Array([-1,-1,-1,-1,5,6,7,4,-1,-1,-1,-1]),new Int16Array([4,5,6,7,11,8,9,10,11,8,9,10]),new Int16Array([0,1,2,3,4,5,6,7,8,9,10,11]),new Int16Array([1,2,3,0,0,1,2,3,5,6,7,4]),new Int16Array([-1,-1,-1,-1,7,4,5,6,-1,-1,-1,-1]),new Int16Array([3,0,1,2,3,0,1,2,4,5,6,7]),new Int16Array([2,3,0,1,-1,-1,-1,-1,0,1,2,3])],this.swaparray=[new Int16Array([0,0,3]),new Int16Array([0,0,6]),new Int16Array([0,0,0]),new Int16Array([0,0,5]),new Int16Array([0,0,0]),new Int16Array([5,0,0]),new Int16Array([0,0,0]),new Int16Array([6,0,0]),new Int16Array([3,0,0])],t<=this.ns_max&&t>0&&(this.nside=t,this.npface=this.nside*this.nside,this.npix=12*this.npface,this.order=this.nside2order(this.nside),this.nl2=2*this.nside,this.nl3=3*this.nside,this.nl4=4*this.nside,this.fact2=4/this.npix,this.fact1=(this.nside<<1)*this.fact2,this.ncap=2*this.nside*(this.nside-1)),this.bn=[],this.mpr=[],this.cmpr=[],this.smpr=[]}computeBn(){for(let t=0;t<=this.order_max;++t)this.bn[t]=new z(1<<t),this.mpr[t]=this.bn[t].maxPixrad(),this.cmpr[t]=D.cos(this.mpr[t]),this.smpr[t]=D.sin(this.mpr[t])}getNPix(){return this.npix}getBoundaries(t){let e=new Array,i=this.nest2xyf(t),s=.5/this.nside,r=(i.ix+.5)/this.nside,n=(i.iy+.5)/this.nside;return e[0]=new O(r+s,n+s,i.face).toVec3(),e[1]=new O(r-s,n+s,i.face).toVec3(),e[2]=new O(r-s,n-s,i.face).toVec3(),e[3]=new O(r+s,n-s,i.face).toVec3(),e}getBoundariesWithStep(t,e){let i=new Array,s=this.nest2xyf(t),r=.5/this.nside,n=(s.ix+.5)/this.nside,a=(s.iy+.5)/this.nside,h=1/(this.nside*e);for(let t=0;t<e;t++)i[t]=new O(n+r-t*h,a+r,s.face).toVec3(),i[t+e]=new O(n-r,a+r-t*h,s.face).toVec3(),i[t+2*e]=new O(n-r+t*h,a-r,s.face).toVec3(),i[t+3*e]=new O(n+r,a-r+t*h,s.face).toVec3();return i}getPointsForXyfNoStep(t,e,i){let s=Math.pow(2,this.order),r=new Array,n=new H(t,e,i),a=.5/s,h=(n.ix+.5)/s,o=(n.iy+.5)/s;return r[0]=new O(h+a,o+a,n.face).toVec3(),r[1]=new O(h-a,o+a,n.face).toVec3(),r[2]=new O(h-a,o-a,n.face).toVec3(),r[3]=new O(h+a,o-a,n.face).toVec3(),r}getPointsForXyf(t,e,i,s){let r=i*Math.pow(2,this.order),n=new Array,a=new H(t,e,s),h=.5/r,o=(a.ix+.5)/r,l=(a.iy+.5)/r;return n[0]=new O(o+h,l+h,a.face).toVec3(),n[1]=new O(o-h,l+h,a.face).toVec3(),n[2]=new O(o-h,l-h,a.face).toVec3(),n[3]=new O(o+h,l-h,a.face).toVec3(),n}neighbours(t){let e=new Int32Array(8),i=this.nest2xyf(t),s=i.ix,r=i.iy,n=i.face;var a=this.nside-1;if(s>0&&s<a&&r>0&&r<a){let t=Math.floor(n<<2*this.order),i=this.spread_bits(s),a=this.spread_bits(r)<<1,h=this.spread_bits(s+1),o=this.spread_bits(r+1)<<1,l=this.spread_bits(s-1),d=this.spread_bits(r-1)<<1;e[0]=t+l+a,e[1]=t+l+o,e[2]=t+i+o,e[3]=t+h+o,e[4]=t+h+a,e[5]=t+h+d,e[6]=t+i+d,e[7]=t+l+d}else for(let t=0;t<8;++t){let i=s+this.xoffset[t],a=r+this.yoffset[t],h=4;i<0?(i+=this.nside,h-=1):i>=this.nside&&(i-=this.nside,h+=1),a<0?(a+=this.nside,h-=3):a>=this.nside&&(a-=this.nside,h+=3);let o=this.facearray[h][n];if(o>=0){let s=this.swaparray[h][n>>>2];if((1&s)>0&&(i=Math.floor(this.nside-i-1)),(2&s)>0&&(a=Math.floor(this.nside-a-1)),(4&s)>0){let t=i;i=a,a=t}e[t]=this.xyf2nest(i,a,o)}else e[t]=-1}return e}nside2order(t){return 0!=(t&t-1)?-1:Math.log2(t)}nest2xyf(t){let e=Math.floor(t&this.npface-1);return new H(this.compress_bits(e),this.compress_bits(e>>1),Math.floor(t>>2*this.order))}xyf2nest(t,e,i){return Math.floor(i<<2*this.order)+this.spread_bits(t)+(this.spread_bits(e)<<1)}loc2pix(t){let e,i=t.z,s=t.phi,r=Math.abs(i),n=this.fmodulo(s*this.inv_halfpi,4);if(r<=this.twothird){let t=this.nside*(.5+n),s=this.nside*(.75*i),r=Math.floor(t-s),a=Math.floor(t+s),h=Math.floor(r>>>this.order),o=Math.floor(a>>>this.order),l=Math.floor(h==o?4|h:h<o?h:o+8),d=Math.floor(a&this.nside-1),c=Math.floor(this.nside-(r&this.nside-1)-1);e=this.xyf2nest(d,c,l)}else{let s=Math.min(3,Math.floor(n)),a=n-s,h=r<.99||!t.have_sth?this.nside*Math.sqrt(3*(1-r)):this.nside*t.sth/Math.sqrt((1+r)/3),o=Math.floor(a*h),l=Math.floor((1-a)*h);o>=this.nside&&(o=this.nside-1),l>=this.nside&&(l=this.nside-1),e=i>=0?this.xyf2nest(Math.floor(this.nside-l-1),Math.floor(this.nside-o-1),s):this.xyf2nest(Math.floor(o),Math.floor(l),s+8)}return e}pix2vec(t){return this.pix2loc(t).toVec3()}pix2zphi(t){return this.pix2loc(t).toZphi()}pix2loc(t){let e,i=new D(void 0),s=this.nest2xyf(t),r=(this.jrll[s.face]<<this.order)-s.ix-s.iy-1;if(r<this.nside){e=r;let t=e*e*this.fact2;i.z=1-t,i.z>.99&&(i.sth=Math.sqrt(t*(2-t)),i.have_sth=!0)}else if(r>this.nl3){e=this.nl4-r;let t=e*e*this.fact2;i.z=t-1,i.z<-.99&&(i.sth=Math.sqrt(t*(2-t)),i.have_sth=!0)}else e=this.nside,i.z=(this.nl2-r)*this.fact1;let n=this.jpll[s.face]*e+s.ix-s.iy;return n<0&&(n+=8*e),i.phi=e==this.nside?.75*L.halfpi*n*this.fact1:.5*L.halfpi*n/e,i}ang2pix(t,e){return this.loc2pix(new D(t))}fmodulo(t,e){if(t>=0)return t<e?t:t%e;var i=t%e+e;return i===e?0:i}compress_bits(t){var e=Math.floor(21845&t)|Math.floor((1431633920&t)>>>15);return this.ctab[255&e]|this.ctab[e>>>8]<<4}spread_bits(t){return Math.floor(this.utab[255&t])|Math.floor(this.utab[t>>>8&255]<<16)|Math.floor(this.utab[t>>>16&255]<<32)|Math.floor(this.utab[t>>>24&255]<<48)}queryPolygonInclusive(t,e){let i=0!=e,s=t.length;if(!(s>=3))return void console.log("not enough vertices in polygon");let r=new Array;for(let e=0;e<s;++e)r[e]=C.pointing2Vec3(t[e]);let n=new Array,a=0,h=0,o=!1;for(;h<r.length;){let t=r[h],e=null,i=null;h==r.length-1?(i=r[1],e=r[0]):h==r.length-2?(i=r[0],e=r[h+1]):(e=r[h+1],i=r[h+2]),n[h]=t.cross(e).norm();let s=n[h].dot(i);if(0==h)a=s<0?-1:1,new B(t),o=!1;else{if(a*s<0){new B(e),r.splice(h+1,1),n.splice(h,1),o=!0,h-=1;continue}new B(t),o=!1}n[h].scale(a),h+=1}s=r.length;let l=new Array(i?s+1:s);if(l=l.fill(L.halfpi),i){let t=new N(r);n[s]=t.getCenter(),l[s]=D.acos(t.getCosrad())}return this.queryMultiDisc(n,l,e)}queryMultiDisc(t,e,i){this.computeBn();let s=0!=i,r=t.length;if(r!=e.length)return void console.error("inconsistent input arrays");let n=new F(8),a=0;s&&(Math.pow(2,this.order_max-this.order)>=i||console.error("invalid oversampling factor"),0!=(i&i-1)&&console.error("oversampling factor must be a power of 2"),a=this.ilog2(i));let h,o,l=this.order+a,d=new Array(l+1);for(h=0;h<=l;++h){d[h]=new Array(r);let t=this.bn[h].maxPixrad();for(o=0;o<r;++o)d[h][o]=new Float64Array(3),d[h][o][0]=e[o]+t>Math.PI?-1:D.cos(e[o]+t),d[h][o][1]=0==h?D.cos(e[o]):d[0][o][1],d[h][o][2]=e[o]-t<0?1:D.cos(e[o]-t)}let c=new X(12+3*l);for(let t=0;t<12;t++)c.push(11-t,0);for(;c.size()>0;){let e=c.ptop(),i=c.otop();c.pop();let a=this.bn[i].pix2vec(e),h=3;for(let e=0;e<r&&h>0;++e){let s=a.dot(t[e]);for(let t=0;t<h;++t)s<d[i][e][t]&&(h=t)}h>0&&this.check_pixel(i,l,h,n,e,c,s)}return n}ilog2(t){let e=Math.max(t,1);return 31-Math.clz32(e)}cosdist_zphi(t,e,i,s){return t*i+D.cos(e-s)*Math.sqrt((1-t*t)*(1-i*i))}check_pixel(t,e,i,s,r,n,a){if(0!=i)if(t<this.order)if(i>=3){let e=2*(this.order-t);s.append1(r<<e,r+1<<e)}else for(let e=0;e<4;++e)n.push(4*r+3-e,t+1);else if(t>this.order)if(i>=2)s.append(r>>>2*(t-this.order)),n.popToMark();else if(t<e)for(let e=0;e<4;++e)n.push(4*r+3-e,t+1);else s.append(r>>>2*(t-this.order)),n.popToMark();else if(i>=2)s.append(r);else if(a)if(this.order<e){n.mark();for(let e=0;e<4;++e)n.push(4*r+3-e,t+1)}else s.append(r)}maxPixrad(){let t=new R(2/3,Math.PI/this.nl4),e=this.convertZphi2xyz(t),i=new C(e[0],e[1],e[2]),s=1-1/this.nside;s*=s;let r=new R(1-s/3,0),n=this.convertZphi2xyz(r),a=new C(n[0],n[1],n[2]);return i.angle(a)}convertZphi2xyz(t){let e=Math.sqrt((1-t.z)*(1+t.z));return[e*D.cos(t.phi),e*D.sin(t.phi),t.z]}queryDiscInclusive(t,e,i){this.computeBn();let s=0!=i,r=new F;if(e>=Math.PI)return r.append1(0,this.npix),r;let n=0;s&&(0!=(i&i-1)&&console.error("oversampling factor must be a power of 2"),n=this.ilog2(i));let a=Math.min(this.order_max,this.order+n),h=C.pointing2Vec3(t),o=new Array(a+1),l=new Array(a+1),d=D.cos(e),c=D.sin(e);for(let t=0;t<=a;t++){let i=this.mpr[t],s=this.cmpr[t],r=this.smpr[t];o[t]=e+i>Math.PI?-1:d*s-c*r,l[t]=e-i<0?1:d*s+c*r}let f=new X(12+3*a);for(let t=0;t<12;t++)f.push(11-t,0);for(;f.size()>0;){let e=f.ptop(),i=f.otop();f.pop();let n=this.bn[i].pix2zphi(e),c=this.cosdist_zphi(h.z,t.phi,n.z,n.phi);if(c>o[i]){let t=c<d?1:c<=l[i]?2:3;this.check_pixel(i,a,t,r,e,f,s)}}return r}}class j{static computeHiPSOrder(t,e){let i=Math.log2(j.RES_ORDER_0/e/t);return i=Math.round(i),i}static computePxSize(t,e){return 1/(e*Math.pow(2,t))*Math.sqrt(Math.PI/3)}static computeBbox(t,e){let i=[];return i.push(new B(null,!1,t.spherical.thetaRad-e,t.spherical.phiRad-e)),i.push(new B(null,!1,t.spherical.thetaRad-e,t.spherical.phiRad+e)),i.push(new B(null,!1,t.spherical.thetaRad+e,t.spherical.phiRad+e)),i.push(new B(null,!1,t.spherical.thetaRad-e,t.spherical.phiRad-e)),i}static setupByTile(t,e){let i={min_y:NaN,max_y:NaN,min_x:NaN,max_x:NaN,gridPointsDeg:[]},s=e.getBoundariesWithStep(t,1),r=[];for(let t=0;t<s.length;t++)if(r[t]=new B(s[t]),t>=1){let e=r[t-1].phi,i=r[t].phi;Math.abs(e-i)>Math.PI&&(r[t-1].phi<r[t].phi?r[t-1].phi+=2*Math.PI:r[t].phi+=2*Math.PI)}for(let t=0;t<r.length;t++){let e=r[t].theta,s=Math.PI/2-e,n=r[t].phi,a=new T(d.ASTRO,l.RADIANS,n,s),h=j.world2intermediate(a.astro);i.gridPointsDeg[2*t]=h[0],i.gridPointsDeg[2*t+1]=h[1],(isNaN(i.max_y)||h[1]>i.max_y)&&(i.max_y=h[1]),(isNaN(i.min_y)||h[1]<i.min_y)&&(i.min_y=h[1]),(isNaN(i.max_x)||h[0]>i.max_x)&&(i.max_x=h[0]),(isNaN(i.min_x)||h[0]<i.min_x)&&(i.min_x=h[0])}return i}static world2intermediate(t){let e,i;if(Math.abs(t.decRad)<=j.THETAX)e=t.raDeg,i=D.sin(t.decRad)*j.K*90/j.H;else if(Math.abs(t.decRad)>j.THETAX){let s=t.raDeg,r=0;(j.K%2!=0||t.decRad>0)&&(r=1);let n=Math.sqrt(j.K*(1-Math.abs(D.sin(t.decRad)))),a=(2*Math.floor((t.raDeg+180)*j.H/360+(1-r)/2)+r)*(180/j.H)-180;e=a+(s-a)*n,i=180/j.H*((j.K+1)/2-n),t.decRad<0&&(i*=-1)}return[e,i]}static intermediate2pix(t,e,i,s){let r,n,a=Math.abs(i.max_x-i.min_x),h=Math.abs(i.max_y-i.min_y);r=(i.min_x>360||i.max_x>360)&&t<i.min_x?(t+360-i.min_x)/a:(t-i.min_x)/a,n=(e-i.min_y)/h;let o=.5-(r-n),l=r+n-.5;return o=Math.floor(o*s),l=Math.floor(l*s),[o,s-l-1]}static pix2intermediate(t,e,i,s,r){let n=s,a=r;s&&(n=s),r&&(a=r);let h=(t+.5)/n,o=(e+.5)/a,l=Math.abs(i.max_x-i.min_x)/2,d=Math.abs(i.max_y-i.min_y)/2,c=(i.max_y+i.min_y)/2;return[i.max_x-l*(h+o),c-d*(o-h)]}static intermediate2world(t,e){let i,s,r=90*(j.K-1)/j.H;if(Math.abs(e)<=r)i=t,s=A(Math.asin(e*j.H/(90*j.K)));else if(Math.abs(e)>r){let r=(j.K+1)/2-Math.abs(e*j.H)/180,n=D.asin(1-r*r/j.K),a=0;(j.K%2!=0||n>0)&&(a=1);let h=(2*Math.floor((t+180)*j.H/360+(1-a)/2)+a)*(180/j.H)-180;i=h+(t-h)/r,s=A(n),e<=0&&(s*=-1)}return new T(d.ASTRO,l.DEGREES,i,s)}}j.DEFAULT_Naxis1_2=512,j.RES_ORDER_0=58.6,j.H=4,j.K=3,j.THETAX=D.asin((j.K-1)/j.K);var V=function(t,e,i,s){return new(i||(i=Promise))((function(r,n){function a(t){try{o(s.next(t))}catch(t){n(t)}}function h(t){try{o(s.throw(t))}catch(t){n(t)}}function o(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,h)}o((s=s.apply(t,e||[])).next())}))};class U{constructor(){this._isGalactic=!1,this._fitsUsed=[],this._wcsname="HPX",this._ctype1="RA---HPX",this._ctype2="DEC--HPX",this._pxvalues=new Map,this._fitsheaderlist=new Array,this._radeclist=new Array}parsePropertiesFile(t){return V(this,void 0,void 0,(function*(){const e=new f(null).getFile(t+"/properties").then((t=>{let e;e=t instanceof ArrayBuffer?new TextDecoder("iso-8859-1").decode(new Uint8Array(t)):t.toString("utf8");const i=e.split("\n");this._HIPS_TILE_WIDTH=512;for(let t of i){if(!t.includes("="))continue;const e=t.split("=");if(void 0===e[1])continue;const i=e[0].trim(),s=e[1].trim();"hips_order"==i?(this._HIPS_MAX_ORDER=parseInt(s),console.log("hips_order "+this._HIPS_MAX_ORDER)):"hips_tile_width"==i?(this._HIPS_TILE_WIDTH=parseInt(s),this._naxis1=this._HIPS_TILE_WIDTH,this._naxis2=this._HIPS_TILE_WIDTH,console.log("hips_tile_width "+this._HIPS_TILE_WIDTH)):"hips_frame"==i&&"galactic"==s&&(this._isGalactic=!0)}return t}));return yield e,e}))}initFromFile(t){return V(this,void 0,void 0,(function*(){let e=new f(t).loadFITS().then((t=>{this._pxvalues.set(0,t.data),this._fitsheaderlist[0]=t.header;let e=t.header.get("ORDER");return this.init(e),this._naxis1=t.header.get("NAXIS1"),this._naxis2=t.header.get("NAXIS2"),this._HIPS_TILE_WIDTH=this._naxis1,this._pixno=t.header.get("NPIX"),this._xyGridProj=j.setupByTile(this._pixno,this._hp),t}));return yield e,e}))}initFromHiPSLocationAndPxSize(t,e){return V(this,void 0,void 0,(function*(){this._hipsBaseURI=t,this._pxsize=e,void 0===this._HIPS_TILE_WIDTH&&(yield this.parsePropertiesFile(t));let i=j.computeHiPSOrder(e,this._HIPS_TILE_WIDTH);i>this._HIPS_MAX_ORDER&&(i=this._HIPS_MAX_ORDER),this.init(i)}))}initFromHiPSLocationAndOrder(t,e){return V(this,void 0,void 0,(function*(){this._hipsBaseURI=t,void 0===this._HIPS_TILE_WIDTH&&(yield this.parsePropertiesFile(t)),e>this._HIPS_MAX_ORDER&&(e=this._HIPS_MAX_ORDER),this._pxsize=j.computePxSize(e,this._HIPS_TILE_WIDTH),this.init(e)}))}init(t){this._norder=t,this._nside=Math.pow(2,t),this._hp=new z(this._nside)}prepareFITSHeader(e){for(let i of this._fitsheaderlist){i.addItemAtTheBeginning(new t("BITPIX",e.get("BITPIX"))),i.addItemAtTheBeginning(new t("SIMPLE",e.get("SIMPLE"))),void 0!==e.get("BLANK")&&i.addItem(new t("BLANK",e.get("BLANK")));let s=1;void 0!==e.get("BSCALE")&&(s=e.get("BSCALE"),i.addItem(new t("BSCALE",s)));let r=0;void 0!==e.get("BZERO")&&(r=e.get("BZERO"),i.addItem(new t("BZERO",r))),i.addItem(new t("NAXIS",2)),i.addItem(new t("NAXIS1",j.DEFAULT_Naxis1_2)),i.addItem(new t("NAXIS2",j.DEFAULT_Naxis1_2)),i.addItem(new t("ORDER",this._norder)),i.addItem(new t("CTYPE1",this._ctype1)),i.addItem(new t("CTYPE2",this._ctype2)),i.addItem(new t("ORIGIN","WCSLight v.0.x")),i.addItem(new t("COMMENT","WCSLight v0.x developed by F.Giordano and Y.Ascasibar"))}return this._fitsheaderlist}getFITSHeader(){return this._fitsheaderlist}getCommonFitsHeaderParams(){return this._fh_common}extractPhysicalValues(t){let e=t.header.get("BZERO"),i=t.header.get("BSCALE"),r=t.header.get("NAXIS1"),n=t.header.get("NAXIS2"),a=t.header.get("BITPIX"),h=Math.abs(a/8),o=(s.convertBlankToBytes(t.header.get("BLANK"),h),new Array(n));for(let l=0;l<n;l++){o[l]=new Array(r);for(let n=0;n<r;n++){let r=e+i*s.extractPixelValue(0,t.data[l].slice(n*h,(n+1)*h),a);o[l][n]=r}}return o}getFITSFiles(t,e){return V(this,void 0,void 0,(function*(){const i=new Map;let s=[],r=new Set;t.forEach((t=>{r.add(t.tileno)}));for(let t of r){let r=t,n=1e4*Math.floor(r/1e4),a=this._hipsBaseURI+"/Norder"+this._norder+"/Dir"+n+"/Npix"+r+".fits",h=new f(a);s.push(h.loadFITS().then((t=>{if(null!==t){let s=void 0!==t.header.get("NPIX")?t.header.get("NPIX"):r;i.set(e+"/Npix"+s+".fits",t)}})))}return yield Promise.all(s),i}))}get fitsUsed(){return this._fitsUsed}getPixValues(t){return V(this,void 0,void 0,(function*(){let e=new Set;t.forEach((t=>{e.add(t.tileno)}));let i,r=t.length,n=[],a=[],h=this;for(let o of e){let e=1e4*Math.floor(o/1e4),l=this._hipsBaseURI+"/Norder"+this._norder+"/Dir"+e+"/Npix"+o+".fits";console.log(`Identified source file ${l}`);let d=new f(l);a.push(d.loadFITS().then((e=>{if(null===e)n.push(void 0);else{h._fitsUsed.push(l);let a=Math.abs(e.header.get("BITPIX")/8);s.convertBlankToBytes(e.header.get("BLANK"),a),void 0===i&&(i=new Uint8Array(r*a)),n.push(e.header);for(let s=0;s<r;s++){let r=t[s];if(r.tileno===o&&r._j<e.header.get("NAXIS1")&&r._i<e.header.get("NAXIS2"))for(let t=0;t<a;t++)i[s*a+t]=e.data[r._j][r._i*a+t]}}})))}return yield Promise.all(a),void 0!==n&&this.prepareCommonHeader(n),i}))}computeSquaredNaxes(t,e){this._naxis1=Math.ceil(t/e),this._naxis2=this._naxis1,this._pxsize=e}prepareCommonHeader(i){if(void 0!==i){this._fh_common||(this._fh_common=new e);for(let e=0;e<i.length;e++){let s=i[e];if(void 0!==s)for(let e of s.getItemList())if(["SIMPLE","BITPIX","BSCALE","BZERO","BLANK","ORDER"].includes(e.key))if(this._fh_common.getItemListOf(e.key)[0]){if(this._fh_common.getItemListOf(e.key)[0].value!==e.value)throw new Error("Error parsing headers. "+e.key+" was "+this._fh_common.getItemListOf(e.key)[0]+" and now is "+e.value)}else this._fh_common.addItem(new t(e.key,e.value))}}}setPxsValue(i,r){let n=Math.abs(r.get("BITPIX")/8),a=void 0!==r.get("BSCALE")?r.get("BSCALE"):1,h=void 0!==r.get("BZERO")?r.get("BZERO"):0;if(void 0===n||void 0===a||void 0===h)throw new Error("BITPIX, BSCALE or BZERO are undefined");let o,d,c,f,p=new Map,u=new Map;this._tileslist.forEach((t=>{this._pxvalues.set(t,new Array(this._HIPS_TILE_WIDTH));for(let e=0;e<this._HIPS_TILE_WIDTH;e++)if(this._pxvalues.has(t)){let i=this._pxvalues.get(t);void 0!==i&&(i[e]=new Uint8Array(this._HIPS_TILE_WIDTH*n))}p.set(""+t,new Array(2)),u.set(""+t,!0)}));for(let t=0;t<this._radeclist.length;t++){[o,d]=this._radeclist[t];let e=I(o,d,l.DEGREES),_=m(e),g=new B(null,!1,_.thetaRad,_.phiRad),w=this._hp.ang2pix(g),y=j.setupByTile(w,this._hp),A=j.world2intermediate(e);if(void 0===this._HIPS_TILE_WIDTH)throw new Error("this._HIPS_TILE_WIDTH undefined");let v=j.intermediate2pix(A[0],A[1],y,this._HIPS_TILE_WIDTH);c=v[0],f=v[1];for(let e=0;e<n;e++){let s=i[t*n+e];if(this._pxvalues.has(w)){let t=this._pxvalues.get(w);void 0!==t&&(t[f][c*n+e]=s)}u.get(""+w)&&0!=s&&u.set(""+w,!1)}let x=p.get(""+w)[0],M=p.get(""+w)[1];if(this._pxvalues.has(w)){let t=this._pxvalues.get(w);if(void 0!==t){let e=h+a*s.extractPixelValue(0,t[f].slice(c*n,c*n+n),r.get("BITPIX"));e<x||isNaN(x)?p.get(""+w)[0]=e:(e>M||isNaN(M))&&(p.get(""+w)[1]=e)}}}return Array.from(this._pxvalues.keys()).forEach((i=>{if(0==u.get(""+i)){let s=new e;s.set("NPIX",i),s.addItem(new t("DATAMIN",p.get(""+i)[0])),s.addItem(new t("DATAMAX",p.get(""+i)[1])),s.addItem(new t("NPIX",i));let r=this._hp.pix2vec(i),n=new B(r),a=A(n.phi),h=90-A(n.theta);s.addItem(new t("CRVAL1",a)),s.addItem(new t("CRVAL2",h)),this._fitsheaderlist.push(s)}else this._pxvalues.delete(i)})),this.prepareFITSHeader(r),this._pxvalues}getImageRADecList(t,e){let i=new B(null,!1,t.spherical.thetaRad,t.spherical.phiRad),s=y(e),r=this._hp.queryDiscInclusive(i,s,4);this._tileslist=[];for(let t=0;t<r.r.length;t++)this._tileslist.includes(r.r[t])||0==r.r[t]||this._tileslist.push(r.r[t]);let n=this._hp.ang2pix(i);this._tileslist.includes(n)||this._tileslist.push(n);let a=t.astro.raDeg-e,h=t.astro.raDeg+e,o=t.astro.decDeg-e,l=t.astro.decDeg+e;return this._tileslist.forEach((t=>{this._xyGridProj=j.setupByTile(t,this._hp);for(let t=0;t<this._HIPS_TILE_WIDTH;t++)for(let e=0;e<this._HIPS_TILE_WIDTH;e++){let i=this.pix2world(e,t);i.astro.raDeg<a||i.astro.raDeg>h||i.astro.decDeg<o||i.astro.decDeg>l||this._radeclist.push([i.astro.raDeg,i.astro.decDeg])}})),this._radeclist}pix2world(t,e){let i=j.pix2intermediate(t,e,this._xyGridProj,this._naxis1,this._naxis2);return j.intermediate2world(i[0],i[1])}convertToGalactic(t){let e=[];const i=Math.PI/180,s=180/Math.PI,r=122.93*i,n=27.1284*i,a=192.8595*i;return t.forEach((([t,h])=>{const o=i*t,l=i*h,d=Math.sin(n)*Math.sin(l)+Math.cos(n)*Math.cos(l)*Math.cos(o-a),c=Math.asin(d)*s,f=Math.atan(Math.cos(l)*Math.sin(o-a)/(Math.sin(l)*Math.cos(n)-Math.cos(l)*Math.sin(n)*Math.cos(o-a))),p=(r-f)*s;e.push([p,c])})),e}world2pix(t){let e,i,s=[];return this._isGalactic&&(t=this.convertToGalactic(t)),t.forEach((([t,r])=>{let n=new T(d.ASTRO,l.DEGREES,t,r),a=new B(null,!1,n.spherical.thetaRad,n.spherical.phiRad);e=this._hp.ang2pix(a),i===e&&void 0!==i||(this._xyGridProj=j.setupByTile(e,this._hp),i=e);let h=j.world2intermediate(n.astro);if(void 0===this._HIPS_TILE_WIDTH)throw new Error("this._HIPS_TILE_WIDTH undefined");let o=j.intermediate2pix(h[0],h[1],this._xyGridProj,this._HIPS_TILE_WIDTH);s.push(new p(o[0],o[1],e))})),s}}class k{}class q extends k{get fitsUsed(){throw new Error("Method not implemented.")}initFromFile(t,e,i,s){throw new Error("Method not implemented.")}prepareFITSHeader(t){throw new Error("Method not implemented.")}getFITSHeader(){throw new Error("Method not implemented.")}getCommonFitsHeaderParams(){throw new Error("Method not implemented.")}extractPhysicalValues(t){throw new Error("Method not implemented.")}getPixValues(t){throw new Error("Method not implemented.")}computeSquaredNaxes(t,e){throw new Error("Method not implemented.")}setPxsValue(t,e){throw new Error("Method not implemented.")}getImageRADecList(t,e,i){throw new Error("Method not implemented.")}pix2world(t,e){throw new Error("Method not implemented.")}world2pix(t){throw new Error("Method not implemented.")}}var K=function(t,e,i,s){return new(i||(i=Promise))((function(r,n){function a(t){try{o(s.next(t))}catch(t){n(t)}}function h(t){try{o(s.throw(t))}catch(t){n(t)}}function o(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,h)}o((s=s.apply(t,e||[])).next())}))};class W extends k{constructor(t){super(),this._ctype1="RA---TAN",this._ctype2="DEC--TAN",t&&(this._inflie=t)}get fitsUsed(){throw new Error("Method not implemented.")}initFromFile(t){return K(this,void 0,void 0,(function*(){let e=new f(t).loadFITS().then((t=>(this._pxvalues.set(0,t.data),this._fitsheader[0]=t.header,this._naxis1=t.header.get("NAXIS1"),this._naxis2=t.header.get("NAXIS2"),this._craDeg=t.header.getItemListOf("CRVAL1")[0].value,this._cdecDeg=t.header.getItemListOf("CRVAL2")[0].value,this._pxsize1=this._fitsheader[0].getItemListOf("CDELT1")[0].value,this._pxsize2=this._fitsheader[0].getItemListOf("CDELT2")[0].value,this._minra=this._craDeg-this._pxsize1*this._naxis1/2,this._minra<0&&(this._minra+=360),this._mindec=this._cdecDeg-this._pxsize2*this._naxis2/2,t)));return yield e,e}))}extractPhysicalValues(t){let e=t.header.get("BZERO"),i=t.header.get("BSCALE"),r=t.header.get("NAXIS1"),n=t.header.get("NAXIS2"),a=t.header.get("BITPIX"),h=Math.abs(a/8),o=(s.convertBlankToBytes(t.header.get("BLANK"),h),new Array(n));for(let l=0;l<n;l++){o[l]=new Array(r);for(let n=0;n<r;n++){let r=e+i*s.extractPixelValue(0,t.data[l].slice(n*h,(n+1)*h),a);o[l][n]=r}}return o}prepareFITSHeader(i){this._fitsheader[0]=new e,this._fitsheader[0].addItemAtTheBeginning(new t("BITPIX",i.get("BITPIX"))),this._fitsheader[0].addItemAtTheBeginning(new t("SIMPLE",i.get("SIMPLE"))),void 0!==i.get("BLANK")&&this._fitsheader[0].addItem(new t("BLANK",i.get("BLANK")));let s=1;void 0!==i.get("BSCALE")&&(s=i.get("BSCALE")),this._fitsheader[0].addItem(new t("BSCALE",s));let r=0;void 0!==i.get("BZERO")&&(r=i.get("BZERO")),this._fitsheader[0].addItem(new t("BZERO",r)),this._fitsheader[0].addItem(new t("NAXIS",2)),this._fitsheader[0].addItem(new t("NAXIS1",this._naxis1)),this._fitsheader[0].addItem(new t("NAXIS2",this._naxis2)),this._fitsheader[0].addItem(new t("CTYPE1",this._ctype1)),this._fitsheader[0].addItem(new t("CTYPE2",this._ctype2)),this._fitsheader[0].addItem(new t("CDELT1",this._pxsize)),this._fitsheader[0].addItem(new t("CDELT2",this._pxsize)),this._fitsheader[0].addItem(new t("CRPIX1",this._naxis1/2)),this._fitsheader[0].addItem(new t("CRPIX2",this._naxis2/2)),this._fitsheader[0].addItem(new t("CRVAL1",this._craDeg)),this._fitsheader[0].addItem(new t("CRVAL2",this._cdecDeg));let n=r+s*this._minphysicalval,a=r+s*this._maxphysicalval;return this._fitsheader[0].addItem(new t("DATAMIN",n)),this._fitsheader[0].addItem(new t("DATAMAX",a)),this._fitsheader[0].addItem(new t("ORIGIN","WCSLight v.0.x")),this._fitsheader[0].addItem(new t("COMMENT","WCSLight v0.x developed by F.Giordano and Y.Ascasibar")),this._fitsheader[0].addItem(new t("END")),this._fitsheader}getFITSHeader(){return this._fitsheader}getCommonFitsHeaderParams(){let i=new e;for(const[e,s]of this._fitsheader[0])["SIMPLE","BITPIX","BSCALE","BZERO","BLANK","ORDER"].includes(e)&&i.addItem(new t(e,s));return i}getPixValues(t){return K(this,void 0,void 0,(function*(){return new Promise(((e,i)=>{try{let i=Math.abs(this._fitsheader[0].get("BITPIX")/8),r=s.convertBlankToBytes(this._fitsheader[0].get("BLANK"),i),n=t.length,a=new Uint8Array(n*i);for(let e=0;e<n;e++){let s=t[e];if(s._j<0||s._j>=this._naxis2||s._i<0||s._i>=this._naxis1)for(let t=0;t<i;t++)a[e*i+t]=r[t];else for(let t=0;t<i;t++)a[e*i+t]=this._pxvalues.get(0)[s._j][s._i*i+t]}e(a)}catch(t){i("[MercatorProjection] ERROR: "+t)}}))}))}computeSquaredNaxes(t,e){this._naxis1=Math.ceil(t/e),this._naxis2=this._naxis1,this._pxsize=e}setPxsValue(t,e){return null}getImageRADecList(t,e,i){return null}pix2world(t,e){let i,s,r=this._fitsheader[0].getItemListOf("CDELT1")[0],n=this._fitsheader[0].getItemListOf("CDELT2")[0],a=this._fitsheader[0].getItemListOf("PC1_1")[0],h=this._fitsheader[0].getItemListOf("PC1_2")[0],o=this._fitsheader[0].getItemListOf("PC2_1")[0],l=this._fitsheader[0].getItemListOf("PC2_2")[0],d=this._fitsheader[0].getItemListOf("CD1_1")[0],c=this._fitsheader[0].getItemListOf("CD1_2")[0],f=this._fitsheader[0].getItemListOf("CD2_1")[0],p=this._fitsheader[0].getItemListOf("CD2_2")[0],u=this._fitsheader[0].getItemListOf("CRPIX1")[0],_=this._fitsheader[0].getItemListOf("CRPIX2")[0];return void 0!==r&&void 0!==n&&void 0!==a&&void 0!==h&&void 0!==o&&void 0!==l?(i=r*(a*(t-u)+h*(e-_)),s=n*(o*(t-u)+l*(e-_))):(i=d*(t-u)+c*(e-_),s=f*(t-u)+p*(e-_)),null}world2pix(t){return this._fitsheader[0].getItemListOf("CDELT1").length>0&&this._fitsheader[0].getItemListOf("CDELT1")[0],this._fitsheader[0].getItemListOf("CDELT2").length>0&&this._fitsheader[0].getItemListOf("CDELT2")[0],this._fitsheader[0].getItemListOf("PC1_1").length>0&&this._fitsheader[0].getItemListOf("PC1_1")[0],this._fitsheader[0].getItemListOf("PC1_2").length>0&&this._fitsheader[0].getItemListOf("PC1_2")[0],this._fitsheader[0].getItemListOf("PC2_1").length>0&&this._fitsheader[0].getItemListOf("PC2_1")[0],this._fitsheader[0].getItemListOf("PC2_2").length>0&&this._fitsheader[0].getItemListOf("PC2_2")[0],this._fitsheader[0].getItemListOf("CD1_1").length>0&&this._fitsheader[0].getItemListOf("CD1_1")[0],this._fitsheader[0].getItemListOf("CD1_2").length>0&&this._fitsheader[0].getItemListOf("CD1_2")[0],this._fitsheader[0].getItemListOf("CD2_1").length>0&&this._fitsheader[0].getItemListOf("CD2_1")[0],this._fitsheader[0].getItemListOf("CD2_2").length>0&&this._fitsheader[0].getItemListOf("CD2_2")[0],this._fitsheader[0].getItemListOf("CRPIX1").length>0&&this._fitsheader[0].getItemListOf("CRPIX1")[0],this._fitsheader[0].getItemListOf("CRPIX2").length>0&&this._fitsheader[0].getItemListOf("CRPIX2")[0],t.forEach((([t,e])=>{})),[]}}class Z{constructor(){}static cutout(t,e,i,s,r){return n=this,a=void 0,o=function*(){const n=r.getImageRADecList(t,e,i);if(0==n.length)return{fitsheader:null,fitsdata:null,inproj:s,outproj:r,fitsused:s.fitsUsed};const a=s.world2pix(n);try{const t=yield s.getPixValues(a),e=s.getCommonFitsHeaderParams();if(void 0!==t){const i=r.setPxsValue(t,e);return{fitsheader:r.getFITSHeader(),fitsdata:i,inproj:s,outproj:r,fitsused:s.fitsUsed}}return{fitsheader:null,fitsdata:null,inproj:s,outproj:r,fitsused:s.fitsUsed}}catch(t){return console.error("[WCSLight] ERROR: "+t),null}},new((h=void 0)||(h=Promise))((function(t,e){function i(t){try{r(o.next(t))}catch(t){e(t)}}function s(t){try{r(o.throw(t))}catch(t){e(t)}}function r(e){var r;e.done?t(e.value):(r=e.value,r instanceof h?r:new h((function(t){t(r)}))).then(i,s)}r((o=o.apply(n,a||[])).next())}));var n,a,h,o}static generateFITS(t,e){return f.generateFITS(t,e)}static changeProjection(t,e){}static getProjection(t){return"Mercator"===t?new S:"HiPS"===t?new U:"HEALPix"===t?new q:"Gnomonic"===t?new W:null}static getAvaillableProjections(){return["Mercator","HiPS","HEALPix"]}}class G{constructor(){this._wcsname="MER",this._ctype1="RA---MER",this._ctype2="DEC--MER",this._pxvalues=new Map,new e,new f("./notexistent/"),new t("mykey","myvalue","mycomment")}get fitsUsed(){throw new Error("Method not implemented.")}initFromFile(t,e,i,s){throw new Error("Method not implemented.")}prepareFITSHeader(t){throw new Error("Method not implemented.")}getFITSHeader(){throw new Error("Method not implemented.")}getCommonFitsHeaderParams(){throw new Error("Method not implemented.")}extractPhysicalValues(t){throw new Error("Method not implemented.")}getPixValues(t){throw new Error("Method not implemented.")}computeSquaredNaxes(t,e){throw new Error("Method not implemented.")}setPxsValue(t,e){throw new Error("Method not implemented.")}getImageRADecList(t,e,i){throw new Error("Method not implemented.")}pix2world(t,e){throw new Error("Method not implemented.")}world2pix(t){throw new Error("Method not implemented.")}}})(),n})()));
//# sourceMappingURL=wcslight.js.map