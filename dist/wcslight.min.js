!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("wcslight",[],e):"object"==typeof exports?exports.wcslight=e():t.wcslight=e()}(self,(()=>(()=>{var t,e,i={152:()=>{},942:()=>{}},r={};function s(t){var e=r[t];if(void 0!==e)return e.exports;var n=r[t]={exports:{}};return i[t].call(n.exports,n,n.exports,s),n.exports}s.m=i,s.d=(t,e)=>{for(var i in e)s.o(e,i)&&!s.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},s.f={},s.e=t=>Promise.all(Object.keys(s.f).reduce(((e,i)=>(s.f[i](t,e),e)),[])),s.u=t=>t+".js",s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),s.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),t={},e="wcslight:",s.l=(i,r,n,a)=>{if(t[i])t[i].push(r);else{var o,l;if(void 0!==n)for(var h=document.getElementsByTagName("script"),c=0;c<h.length;c++){var u=h[c];if(u.getAttribute("src")==i||u.getAttribute("data-webpack")==e+n){o=u;break}}o||(l=!0,(o=document.createElement("script")).charset="utf-8",o.timeout=120,s.nc&&o.setAttribute("nonce",s.nc),o.setAttribute("data-webpack",e+n),o.src=i),t[i]=[r];var d=(e,r)=>{o.onerror=o.onload=null,clearTimeout(p);var s=t[i];if(delete t[i],o.parentNode&&o.parentNode.removeChild(o),s&&s.forEach((t=>t(r))),e)return e(r)},p=setTimeout(d.bind(null,void 0,{type:"timeout",target:o}),12e4);o.onerror=d.bind(null,o.onerror),o.onload=d.bind(null,o.onload),l&&document.head.appendChild(o)}},s.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},(()=>{var t;s.g.importScripts&&(t=s.g.location+"");var e=s.g.document;if(!t&&e&&(e.currentScript&&(t=e.currentScript.src),!t)){var i=e.getElementsByTagName("script");if(i.length)for(var r=i.length-1;r>-1&&(!t||!/^http(s?):/.test(t));)t=i[r--].src}if(!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),s.p=t})(),(()=>{var t={434:0,992:0};s.f.j=(e,i)=>{var r=s.o(t,e)?t[e]:void 0;if(0!==r)if(r)i.push(r[2]);else{var n=new Promise(((i,s)=>r=t[e]=[i,s]));i.push(r[2]=n);var a=s.p+s.u(e),o=new Error;s.l(a,(i=>{if(s.o(t,e)&&(0!==(r=t[e])&&(t[e]=void 0),r)){var n=i&&("load"===i.type?"missing":i.type),a=i&&i.target&&i.target.src;o.message="Loading chunk "+e+" failed.\n("+n+": "+a+")",o.name="ChunkLoadError",o.type=n,o.request=a,r[1](o)}}),"chunk-"+e,e)}};var e=(e,i)=>{var r,n,[a,o,l]=i,h=0;if(a.some((e=>0!==t[e]))){for(r in o)s.o(o,r)&&(s.m[r]=o[r]);l&&l(s)}for(e&&e(i);h<a.length;h++)n=a[h],s.o(t,n)&&t[n]&&t[n][0](),t[n]=0},i=self.webpackChunkwcslight=self.webpackChunkwcslight||[];i.forEach(e.bind(null,0)),i.push=e.bind(null,i.push.bind(i))})();var n={};return(()=>{"use strict";s.r(n),s.d(n,{AbstractProjection:()=>p,CoordsType:()=>c,HiPSFITS:()=>$,HiPSHelper:()=>j,HiPSProj:()=>W,ImagePixel:()=>tt,MercatorProjection:()=>b,NumberType:()=>h,Point:()=>M,WCSLight:()=>J,astroToSpherical:()=>m,cartesianToSpherical:()=>f,degToRad:()=>x,fillAstro:()=>y,fillSpherical:()=>w,radToDeg:()=>A,sphericalToAstro:()=>g,sphericalToCartesian:()=>I});class t{constructor(t,e,i){this._key="",this._value="",this._comment="",this._key=t,this._value=e,this._comment=i}get key(){return this._key}get comment(){return this._comment}get value(){return this._value}}class e{constructor(){this.items=[],this.items[0]=new t(e.SIMPLE,"T",""),this.items[1]=new t(e.BITPIX,"",""),this.items[2]=new t(e.NAXIS,2,""),this.items[3]=new t(e.NAXIS1,"",""),this.items[4]=new t(e.NAXIS2,"","")}insert(t){t.key===e.SIMPLE?this.items[0]=t:t.key===e.BITPIX?this.items[1]=t:t.key===e.NAXIS?this.items[2]=t:t.key===e.NAXIS1?this.items[3]=t:t.key===e.NAXIS2?this.items[4]=t:this.items.push(t)}getItems(){return this.items}remove(t){this.items=this.items.filter((e=>e.key!==t))}findById(t){return this.items.find((e=>e.key===t))||null}}e.SIMPLE="SIMPLE",e.BITPIX="BITPIX",e.BZERO="BZERO",e.BSCALE="BSCALE",e.BLANK="BLANK",e.NAXIS="NAXIS",e.NAXIS1="NAXIS1",e.NAXIS2="NAXIS2",e.DATAMIN="DATAMIN",e.DATAMAX="DATAMAX",e.CRVAL1="CRVAL1",e.CRVAL2="CRVAL2",e.CTYPE1="CTYPE1",e.CTYPE2="CTYPE2",e.CRPIX1="CRPIX1",e.CRPIX2="CRPIX2",e.ORIGIN="ORIGIN",e.COMMENT="COMMENT";var i=s(152);class r{static createFITS(t){const e=this.createHeader(t.header),i=this.createData(t.data),r=new Uint8Array(e.length+i.length);return r.set(e,0),r.set(i,e.length),r}static createHeader(t){let e="";for(const i of t.getItems())"END"!==i.key&&(e+=`${i.key?i.key.padEnd(8," "):"        "}${void 0!==i.value?`= ${i.value}`:""}${i.comment?` / ${i.comment}`:""}`.padEnd(80," "));for(e+="END".padEnd(80," ");e.length%2880!=0;)e+=" ";return(new TextEncoder).encode(e)}static createData(t){let e=t.reduce(((t,e)=>t+e.length),0),i=new Uint8Array(e),r=0;for(let e of t)i.set(e,r),r+=e.length;return i}static typedArrayToURL(t){const e=this.createFITS(t),i=new Blob([e],{type:"application/fits"}),r=URL.createObjectURL(i);return console.log(`Generated FITS file URL: ${r}`),setTimeout((()=>r),1e4),console.log(`Generated FITS will be available for 10 seconds: ${r}`),r}static writeFITSFile(t,e){const r=this.createFITS(t);try{i.writeFileSync(e,r),console.log(`FITS file written successfully to: ${e}`)}catch(t){console.error(`Error writing FITS file: ${t}`)}}}class a{static getFITSItemValue(t,e){const i=t.findById(e);let r=null;return i&&(r=Number(i.value)),r}static parse(i){const r=new TextDecoder("ascii").decode(i.slice(0,2880)),s=new e,n=r.match(/.{1,80}/g)||[];for(const e of n){const i=e.slice(0,8).trim();let r,n="";if(i&&"END"!==i){const a=e.slice(10).trim().split("/")[0].trim();r=isNaN(Number(a))?a:Number(a),e.includes("/")&&(n=e.slice(10).trim().split("/")[1].trim());const o=new t(i,r,n);s.insert(o)}}return s}}class o{static getStringAt(t,e,i){const r=[];for(let s=e,n=0;s<e+i;s++,n++)r[n]=String.fromCharCode(255&t.charCodeAt(s));return r.join("")}static byteString(t){if(t<0||t>255||t%1!=0)throw new Error(t+" does not fit in a byte");return("000000000"+t.toString(2)).substr(-8)}static parse32bitSinglePrecisionFloatingPoint(t,e,i,r){let s=(((t<<8)+e<<8)+i<<8)+r;return s<0&&(s+=4294967296),(1+(8388607&s)/8388608)*Math.pow(2,((2139095040&s)>>23)-127)}static convertBlankToBytes(t,e){let i=Math.abs(t).toString(2);for(;i.length/8<e;)i+="0";const r=new ArrayBuffer(e),s=new Uint8Array(r);for(let t=0;t<e;t++)s[t]=parseInt(i.substr(8*t,8*(t+1)),2);return s}static parseFloatingPointFormat(t,e,i){const r=[];for(let e=t.length;e;e-=1){let i=t[e-1];for(let t=8;t;t-=1)r.push(i%2?1:0),i>>=1}r.reverse();const s=r.join(""),n=(1<<e-1)-1,a=parseInt(s.substring(0,1),2)?-1:1,o=parseInt(s.substring(1,1+e),2),l=parseInt(s.substring(1+e),2);return o===(1<<e)-1?0!==l?null:a*(1/0):o>0?a*Math.pow(2,o-n)*(1+l/Math.pow(2,i)):0!==l?a*Math.pow(2,-(n-1))*(l/Math.pow(2,i)):0*a}static generate16bit2sComplement(t){throw new TypeError("not implemented yet"+t)}static parse16bit2sComplement(t,e){const i=t<<8|e;return 32768&i?4294901760|i:i}static parse32bit2sComplement(t,e,i,r){const s=t<<24|e<<16|i<<8|r;let n=4294967295&s;return(2147483648&s)>>31?(n=1+(4294967295&~s),-1*n):n}static getByteAt(t,e){return 255&t.charCodeAt(e+0)}static extractPixelValue(t,e,i){let r=null;if(8==i)r=e[0];else if(16==i)r=o.parse16bit2sComplement(e[t],e[t+1]);else if(32==i)r=o.parse32bit2sComplement(e[t],e[t+1],e[t+2],e[t+3]);else if(-32==i)r=o.parseFloatingPointFormat(e.slice(t,t+8),8,23);else{if(64==i)throw new Error("BITPIX=64 -> 64-bit 2's complement binary integer NOT supported yet.");-64==i&&(r=o.parseFloatingPointFormat(e.slice(t,t+8),11,52))}return r}}class l{static computePhysicalMinAndMax(i,r){const s=a.getFITSItemValue(i,e.BITPIX);if(null===s)return null;const n=a.getFITSItemValue(i,e.NAXIS1);if(null===n)return null;const o=a.getFITSItemValue(i,e.NAXIS2);if(null===o)return null;const h=a.getFITSItemValue(i,e.DATAMIN),c=a.getFITSItemValue(i,e.DATAMAX);if(!s||!n||!o)return null;if(!c||!h){const[e,s]=l.computePhysicalValues(r,i);if(e&&s){const r=new t("DATAMAX",e,"computed by jsfitsio"),n=new t("DATAMIN",s,"computed by jsfitsio");i.insert(r),i.insert(n)}}const u=new t("END","","");return i.insert(u),i}static computePhysicalValues(t,i){const r=a.getFITSItemValue(i,e.BITPIX);if(null===r||isNaN(r))return[null,null];const s=a.getFITSItemValue(i,e.BLANK);if(null===s||isNaN(r))return[null,null];let n=a.getFITSItemValue(i,e.BZERO);null===n&&(n=0);let o=a.getFITSItemValue(i,e.BSCALE);null===o&&(o=1);let h=0;const c=Math.abs(r/8),u=t.byteLength/c;let d=null,p=null,f=null;for(s&&(f=l.pixel2physicalValue(s,o,n));h<u;){let e=l.extractPixelValue(t,c*h,r);if(null===e){h++;continue}let i=l.pixel2physicalValue(e,o,n);d||(d=i),p||(p=i),null!==f&&f===i||(null!==i&&(i<d||null===d)&&(d=i),null!==i&&(i>p||null===p)&&(p=i)),h++}return[d,p]}static pixel2physicalValue(t,e,i){if(null===i||null===e)throw new Error("Either BZERO or BSCALE is null");return i+e*t}static extractPixelValue(t,e,i){let r=null;if(16==i)r=o.parse16bit2sComplement(t[e],t[e+1]);else if(32==i)r=o.parse32bit2sComplement(t[e],t[e+1],t[e+2],t[e+3]);else if(-32==i)r=o.parseFloatingPointFormat(t.slice(e,e+4),8,23);else{if(64==i)throw new Error("BITPIX=64 -> 64-bit 2's complement binary integer NOT supported yet.");-64==i&&(r=o.parseFloatingPointFormat(t.slice(e,e+8),11,52))}return r}}var h,c,u=function(t,e,i,r){return new(i||(i=Promise))((function(s,n){function a(t){try{l(r.next(t))}catch(t){n(t)}}function o(t){try{l(r.throw(t))}catch(t){n(t)}}function l(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}l((r=r.apply(t,e||[])).next())}))};class d{static loadFITS(t){return u(this,void 0,void 0,(function*(){const e=yield d.getFile(t);return(null==e?void 0:e.byteLength)?d.processFits(e):null}))}static processFits(t){const e=a.parse(t),i=l.computePhysicalMinAndMax(e,t);if(null==i)return null;const r=new Uint8Array(t.slice(2880));return{header:i,data:d.createMatrix(r,e)}}static createMatrix(t,i){const r=a.getFITSItemValue(i,e.NAXIS1);if(null===r)throw new Error("NAXIS1 not defined.");const s=a.getFITSItemValue(i,e.NAXIS2);if(null===s)throw new Error("NAXIS2 not defined.");const n=a.getFITSItemValue(i,e.BITPIX);if(null===n)throw new Error("BITPIX not defined.");const o=Math.abs(n/8);if(t.length!==r*s*o)throw new Error("Payload size does not match the expected matrix dimensions.");const l=[];for(let e=0;e<s;e++)l.push(t.slice(e*r*o,(e+1)*r*o));return l}static generateFITSForWeb(t){return r.typedArrayToURL(t)}static saveFITSLocally(t,e){return r.writeFITSFile(t,e)}static getFile(t){return u(this,void 0,void 0,(function*(){if(t.substring(0,5).toLowerCase().includes("http")){const e=yield s.e(720).then(s.bind(s,720)),i=yield e.getFile(t);return(null==i?void 0:i.byteLength)?new Uint8Array(i):new Uint8Array(0)}{const e=yield s.e(913).then(s.bind(s,913)),i=yield e.getLocalFile(t);return(null==i?void 0:i.length)?new Uint8Array(i):new Uint8Array(0)}}))}}class p{}function f(t){let e=(r=t,(i=t).x*r.x+i.y*r.y+i.z*r.z);var i,r;let s=Math.sqrt(e),n=Math.acos(t.z/s),a=A(n),o=Math.atan2(t.y,t.x),l=A(o);return l<0&&(l+=360),{phiDeg:l,thetaDeg:a,phiRad:o,thetaRad:n}}function g(t){let e,i;return e=t.phiDeg,e<0&&(e+=360),i=90-t.thetaDeg,{raDeg:e,decDeg:i,raRad:x(e),decRad:x(i)}}function m(t){let e,i;return e=t.raDeg,e<0&&(e+=360),i=90-t.decDeg,{phiDeg:e,thetaDeg:i,phiRad:x(e),thetaRad:x(i)}}function I(t,e){return{x:(e=null==e?1:e)*Math.sin(t.thetaRad)*Math.cos(t.phiRad),y:e*Math.sin(t.thetaRad)*Math.sin(t.phiRad),z:e*Math.cos(t.thetaRad)}}function y(t,e,i){return i==h.DEGREES?{raDeg:t,decDeg:e,raRad:x(t),decRad:x(e)}:i==h.RADIANS?{raRad:t,decRad:e,raDeg:A(t),decDeg:A(e)}:(console.error("Wrong operation. NumberType "+i+" not supported"),null)}function w(t,e,i){return i==h.DEGREES?{phiDeg:t,thetaDeg:e,phiRad:x(t),thetaRad:x(e)}:i==h.RADIANS?{phiDeg:A(t),thetaDeg:A(e),phiRad:t,thetaRad:e}:(console.error("Wrong operation. NumberType "+i+" not supported"),null)}function x(t){return t/180*Math.PI}function A(t){return 180*t/Math.PI}!function(t){t[t.DEGREES=0]="DEGREES",t[t.RADIANS=1]="RADIANS",t[t.DECIMAL=2]="DECIMAL",t[t.HMS=3]="HMS",t[t.DMS=4]="DMS"}(h||(h={})),function(t){t.CARTESIAN="cartesian",t.SPHERICAL="spherical",t.ASTRO="astro"}(c||(c={}));class v{}v.MAX_DECIMALS=6;class M{constructor(t,e,...i){if(t==c.CARTESIAN)this.cartesian.x=parseFloat(i[0].toFixed(v.MAX_DECIMALS)),this.cartesian.y=parseFloat(i[1].toFixed(v.MAX_DECIMALS)),this.cartesian.z=parseFloat(i[2].toFixed(v.MAX_DECIMALS)),this.spherical=f(this.cartesian),this.astro=g(this.spherical);else if(t==c.ASTRO){const t=y(i[0],i[1],e);null!==t&&(this.astro=t,this.spherical=m(this.astro),this.cartesian=I(this.spherical,1))}else if(t==c.SPHERICAL){const t=w(i[0],i[1],e);null!==t&&(this.spherical=t,this.cartesian=I(this.spherical,1),this.astro=g(this.spherical))}else console.error("CoordsType "+t+" not recognised.");this.spherical.phiDeg>360&&(this.spherical.phiDeg-=360),this.astro.raDeg>360&&(this.astro.raDeg-=360)}getSpherical(){return this.spherical}getAstro(){return this.astro}getCartesian(){return this.cartesian}}class P{constructor(t,e){this.min=t,this.max=e}getMinValue(){return this.min}getMaxValue(){return this.max}}class S{constructor(t,e,i,r,s,n){this.centralDec=e,this.centralRA=t,this.maxDec=n,this.maxRA=s,this.minRA=i,this.minDec=r}getMinRA(){return this.minRA}getMinDec(){return this.minDec}getMaxRA(){return this.maxRA}getMaxDec(){return this.maxDec}getCentralRA(){return this.centralRA}getCentralDec(){return this.centralDec}setMinRA(t){this.minRA=t}setMinDec(t){this.minDec=t}setMaxRA(t){this.maxRA=t}setMaxDec(t){this.maxDec=t}setCentralRA(t){this.centralRA=t}setCentralDec(t){this.centralDec=t}}class N{constructor(){this.minPixelValue=null,this.maxPixelValue=null,this.BZERO=null,this.BSCALE=null,this.BLANK=null,this.tileList=[],this.imagePixelList=new Array}setBZERO(t){this.BZERO=t}setBSCALE(t){this.BSCALE=t}setBLANK(t){this.BLANK=t}getBZERO(){return this.BZERO}getBSCALE(){return this.BSCALE}getBLANK(){return this.BLANK}findImagePixel(t,e){return this.imagePixelList.find((i=>i.i===t&&i.j===e))||null}getImagePixelsByTile(t){return this.imagePixelList.filter((e=>e.tileno===t))}getImagePixelList(){return this.imagePixelList}getTilesList(){return this.tileList}addImagePixel(t){this.imagePixelList.push(t)}addTileNumber(t){this.tileList.includes(t)||this.tileList.push(t)}computeRADecMinMaxCentral(){if(0===this.imagePixelList.length)return null;let t=1/0,e=-1/0,i=1/0,r=-1/0;for(const s of this.imagePixelList)Number.isFinite(s.ra)&&(s.ra<t&&(t=s.ra),s.ra>e&&(e=s.ra)),Number.isFinite(s.dec)&&(s.dec<i&&(i=s.dec),s.dec>r&&(r=s.dec));return Number.isFinite(t)&&Number.isFinite(e)&&Number.isFinite(i)&&Number.isFinite(r)?new S(t+(e-t)/2,i+(r-i)/2,t,i,e,r):null}setMinMaxValue(t){t&&(this.minPixelValue?t<this.minPixelValue&&(this.minPixelValue=t):this.minPixelValue=t,this.maxPixelValue?t>this.minPixelValue&&(this.maxPixelValue=t):this.maxPixelValue=t)}getMinMaxValues(){return this.minPixelValue&&this.maxPixelValue?new P(this.minPixelValue,this.maxPixelValue):null}}class T{constructor(t,e,i){this.uint8value=null,this.value=null,this.tileno=i,Number.isInteger(t)&&Number.isInteger(e)?(this.i=t,this.j=e,this.ra=NaN,this.dec=NaN):(this.ra=t,this.dec=e,this.i=-1,this.j=-1)}geti(){return this.i}getj(){return this.j}getRADeg(){return this.ra}getDecDeg(){return this.dec}getUint8Value(){return this.uint8value}getValue(){return this.value}setValue(t,e){if(null==this.uint8value){const t=Math.abs(e/8);this.uint8value=new Uint8Array(t)}this.uint8value=t,this.value=o.extractPixelValue(0,t,e)}setTileNumber(t){this.tileno=t}setij(t,e){this.i=t,this.j=e}setRADecDeg(t,e){this.ra=t,this.dec=e}}class E{constructor(t,e){this.payload=[],this.header=t,this.setData(e)}setData(t){this.payload=Array.from(t.values()).flatMap((t=>t))}getHeader(){return this.header}getData(){return this.payload}}class b extends p{constructor(){super(),this.CTYPE1="'RA---CAR'",this.CTYPE2="'DEC--CAR'",this._wcsname="MER",this.pxvalues=new Array,this.fitsheader=new e}initFromFile(t){return e=this,i=void 0,s=function*(){var e,i,r,s,n,a,o;const l=yield d.loadFITS(t);if(!l)throw console.error("FITS is null"),new Error("FITS is null");this.pxvalues=l.data,this.fitsheader=l.header,this.naxis1=Number(null===(e=l.header.findById("NAXIS1"))||void 0===e?void 0:e.value),this.naxis2=Number(null===(i=l.header.findById("NAXIS2"))||void 0===i?void 0:i.value),this.bitpix=null===(r=l.header.findById("BITPIX"))||void 0===r?void 0:r.value,this.craDeg=null===(s=l.header.findById("CRVAL1"))||void 0===s?void 0:s.value,this.cdecDeg=null===(n=l.header.findById("CRVAL2"))||void 0===n?void 0:n.value;const h=null===(a=this.fitsheader.findById("CDELT1"))||void 0===a?void 0:a.value,c=null===(o=this.fitsheader.findById("CDELT2"))||void 0===o?void 0:o.value;if(h!==c||void 0===h||void 0===c)throw new Error("pxsize1 is not equal to pxsize2");return this.pxsize=h,this.minra=this.craDeg-this.pxsize*this.naxis1/2,this.minra<0&&(this.minra+=360),this.mindec=this.cdecDeg-this.pxsize*this.naxis2/2,l},new((r=void 0)||(r=Promise))((function(t,n){function a(t){try{l(s.next(t))}catch(t){n(t)}}function o(t){try{l(s.throw(t))}catch(t){n(t)}}function l(e){var i;e.done?t(e.value):(i=e.value,i instanceof r?i:new r((function(t){t(i)}))).then(a,o)}l((s=s.apply(e,i||[])).next())}));var e,i,r,s}getBytePerValue(){return Math.abs(this.bitpix/8)}extractPhysicalValues(t){var e,i,r,s,n;const a=Number(null===(e=t.header.findById("BZERO"))||void 0===e?void 0:e.value),l=Number(null===(i=t.header.findById("BSCALE"))||void 0===i?void 0:i.value),h=Number(null===(r=t.header.findById("NAXIS1"))||void 0===r?void 0:r.value),c=Number(null===(s=t.header.findById("NAXIS2"))||void 0===s?void 0:s.value),u=Number(null===(n=t.header.findById("BITPIX"))||void 0===n?void 0:n.value),d=Math.abs(u/8);let p=new Array(c);for(let e=0;e<c;e++){p[e]=new Array(h);for(let i=0;i<h;i++){const r=o.extractPixelValue(0,t.data[e].slice(i*d,(i+1)*d),u);if(r){let t=a+l*r;p[e][i]=t}}}return p}prepareHeader(i,r,s,n,a,o,l,h,c,u){const d=new e;d.insert(new t("SIMPLE","T","")),d.insert(new t("NAXIS1",s,"")),d.insert(new t("NAXIS2",s,"")),d.insert(new t("NAXIS",2,"")),d.insert(new t("BITPIX",r,"")),d.insert(new t("BLANK",n,"")),d.insert(new t("BSCALE",o,"")),d.insert(new t("BZERO",a,"")),d.insert(new t("CTYPE1",this.CTYPE1,"")),d.insert(new t("CTYPE2",this.CTYPE2,"")),d.insert(new t("CDELT1",i,"")),d.insert(new t("CDELT2",i,"")),d.insert(new t("CRPIX1",s/2,"")),d.insert(new t("CRPIX2",s/2,"")),d.insert(new t("CRVAL1",l,"")),d.insert(new t("CRVAL2",h,""));const p=a+o*c,f=a+o*u;return d.insert(new t("DATAMIN",p,"")),d.insert(new t("DATAMAX",f,"")),d.insert(new t("ORIGIN","'WCSLight v.0.x'","")),d.insert(new t("COMMENT","","'WCSLight v0.x developed by F.Giordano and Y.Ascasibar'")),d.insert(new t("END","","")),d}getFITSHeader(){return this.fitsheader}getCommonFitsHeaderParams(){let i=new e;for(const e of this.fitsheader.getItems()){const r=e.key;if(["SIMPLE","BITPIX","BSCALE","BZERO","BLANK","ORDER"].includes(r)){const s=e.value;i.insert(new t(r,s,""))}}return i}computeNaxisWidth(t,e){return Math.ceil(2*t/e)}getImageRADecList(t,e,i,r){const s=r,n=s;let a=t.getAstro().raDeg-e;a<0&&(a+=360);const o=t.getAstro().decDeg-e,l=new N;for(let t=0;t<n;t++)for(let e=0;e<s;e++)l.addImagePixel(new T(a+e*i,o+t*i,void 0));return l.getImagePixelList().length,l}pix2world(t,e){let i,r;return i=t*this.pxsize+this.minra,r=e*this.pxsize+this.mindec,new M(c.ASTRO,h.DEGREES,i,r)}setPixelValues(t,e){var i,r,s,n;const a=null===(i=e.findById("BITPIX"))||void 0===i?void 0:i.value;if(!Number.isFinite(a))throw new Error("BITPIX not found or invalid in header");const o=Math.abs(a)/8,l=null===(r=e.findById("NAXIS1"))||void 0===r?void 0:r.value,h=null!==(n=null===(s=e.findById("NAXIS2"))||void 0===s?void 0:s.value)&&void 0!==n?n:l;if(!Number.isFinite(l)||l<=0)throw new Error("NAXIS1 not found or invalid");if(!Number.isFinite(h)||h<=0)throw new Error("NAXIS2 not found or invalid");const c=t.getImagePixelList();if(c.length!==l*h)throw new Error(`Pixel count mismatch: got ${c.length}, expected ${l*h}`);const u=new Map;for(let t=0;t<h;t++)u.set(t,new Array(l));for(let t=0;t<c.length;t++){const e=Math.floor(t/l),i=t%l,r=u.get(e);let s=c[t].getUint8Value();if(null==s)throw new Error(`Pixel (${e},${i}) missing Uint8Array for BITPIX=${a}`);if(s.byteLength!==o)throw new Error(`Pixel (${e},${i}) byteLength=${s.byteLength} != expected ${o} (BITPIX=${a})`);r[i]=s}return new E(e,u)}generateFITSFile(t,e,i,r,s,n,a,o,l,h,c){const u=this.prepareHeader(t,e,i,r,s,n,a,o,l,h);return this.setPixelValues(c,u)}world2pix(t){var e;const i=this.getBytePerValue(),r=Number(null===(e=this.fitsheader.findById("BLANK"))||void 0===e?void 0:e.value),s=o.convertBlankToBytes(r,i);for(let e of t.getImagePixelList()){const r=e.getRADeg(),n=e.getDecDeg(),a=Math.floor((r-this.minra)/this.pxsize),o=Math.floor((n-this.mindec)/this.pxsize);if(o<0||o>=this.naxis2||a<0||a>=this.naxis1)e.setValue(s,this.bitpix);else{const t=this.pxvalues[o].slice(a*i,(a+1)*i);e.setValue(t,this.bitpix)}t.setMinMaxValue(e.getValue())}return t}}class R{}R.halfpi=1.5707963267948966,R.inv_halfpi=2/Math.PI,R.twopi=2*Math.PI,R.inv_twopi=1/(2*Math.PI);class B{constructor(t,e){this.z=t,this.phi=e}}class D{constructor(t){D.PI4_A=.7853981554508209,D.PI4_B=7.946627356147928e-9,D.PI4_C=3061616997868383e-32,D.M_1_PI=.3183098861837907,t&&(this.sth=0,this.have_sth=!1,this.z=D.cos(t.theta),this._phi=t.phi,Math.abs(this.z)>.99&&(this.sth=D.sin(t.theta),this.have_sth=!0))}setZ(t){this.z=t}get phi(){return this._phi}set phi(t){this._phi=t}setSth(t){this.sth=t}toVec3(){var t=this.have_sth?this.sth:Math.sqrt((1-this.z)*(1+this.z));return new L(t*Math.cos(this.phi),t*Math.sin(this.phi),this.z)}toZphi(){return new B(this.z,this.phi)}static sin(t){let e=t*D.M_1_PI,i=Math.floor(e<0?e-.5:e+.5),r=4*i;return t-=r*D.PI4_A,t-=r*D.PI4_B,t-=r*D.PI4_C,1&i&&(t=-t),this.sincoshelper(t)}static cos(t){let e=t*D.M_1_PI-.5,i=1+2*Math.floor(e<0?e-.5:e+.5),r=2*i;return t-=r*D.PI4_A,t-=r*D.PI4_B,t-=r*D.PI4_C,2&i||(t=-t),D.sincoshelper(t)}static sincoshelper(t){let e=t*t,i=-7972559550090379e-33;return i=i*e+2810099727108632e-30,i=i*e-7647122191181588e-28,i=i*e+1.605904306056645e-10,i=i*e-2.5052108376350205e-8,i=i*e+27557319223919875e-22,i=i*e-.00019841269841269616,i=i*e+.00833333333333333,i=i*e-.16666666666666666,e*i*t+t}static asin(t){return D.mulsign(D.atan2k(Math.abs(t),Math.sqrt((1+t)*(1-t))),t)}static acos(t){return D.mulsign(D.atan2k(Math.sqrt((1+t)*(1-t)),Math.abs(t)),t)+(t<0?Math.PI:0)}static mulsign(t,e){return D.copySign(1,e)*t}static copySign(t,e){return e<0?-Math.abs(t):Math.abs(t)}static atanhelper(t){let e=t*t,i=-1887960084630735e-20;return i=i*e+.00020985007664581698,i=i*e-.0011061183148667248,i=i*e+.003700267441887131,i=i*e-.008898961958876555,i=i*e+.016599329773529202,i=i*e-.025451762493231264,i=i*e+.03378525800013531,i=i*e-.04076291912768365,i=i*e+.04666671500778406,i=i*e-.052367485230348246,i=i*e+.05876663929266736,i=i*e-.06665735793610805,i=i*e+.07692195383117696,i=i*e-.09090899500824501,i=i*e+.11111110564826142,i=i*e-.1428571426677133,i=i*e+.19999999999659127,i=i*e-.3333333333333111,i*e*t+t}static atan2k(t,e){let i=0;if(e<0&&(e=-e,i=-2),t>e){let r=e;e=t,t=-r,i+=1}return D.atanhelper(t/e)+i*(Math.PI/2)}static atan2(t,e){let i=D.atan2k(Math.abs(t),e);return i=D.mulsign(i,e),(D.isinf(e)||0==e)&&(i=Math.PI/2-(D.isinf(e)?D.copySign(1,e)*(Math.PI/2):0)),D.isinf(t)&&(i=Math.PI/2-(D.isinf(e)?D.copySign(1,e)*(1*Math.PI/4):0)),0==t&&(i=-1==D.copySign(1,e)?Math.PI:0),D.isnan(e)||D.isnan(t)?NaN:D.mulsign(i,t)}static isnan(t){return t!=t}static isinf(t){return Math.abs(t)===1/0}}D.PI4_A=.7853981554508209,D.PI4_B=7.946627356147928e-9,D.PI4_C=3061616997868383e-32,D.M_1_PI=.3183098861837907;class C{constructor(t,e,i,r){null!=t?(this.theta=D.atan2(Math.sqrt(t.x*t.x+t.y*t.y),t.z),this.phi=e?-D.atan2(t.y,t.x):D.atan2(t.y,t.x),this.phi<0&&(this.phi=this.phi+2*Math.PI),this.phi>=2*Math.PI&&(this.phi=this.phi-2*Math.PI)):(this.theta=i,this.phi=r)}}class L{constructor(t,e,i){if(t instanceof C){let e=t,i=D.sin(e.theta);this.x=i*D.cos(e.phi),this.y=i*D.sin(e.phi),this.z=D.cos(e.theta)}else this.x=t,this.y=e,this.z=i}getX(){return this.x}getY(){return this.y}getZ(){return this.z}scale(t){this.x*=t,this.y*=t,this.z*=t}cross(t){return new L(this.y*t.z-t.y*this.z,this.z*t.x-t.z*this.x,this.x*t.y-t.x*this.y)}add(t){return new L(this.x+t.x,this.y+t.y,this.z+t.z)}normalize(){let t=1/this.length();this.x*=t,this.y*=t,this.z*=t}norm(){let t=1/this.length();return new L(this.x*t,this.y*t,this.z*t)}length(){return Math.sqrt(this.lengthSquared())}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}sub(t){return new L(this.x-t.x,this.y-t.y,this.z-t.z)}angle(t){return D.atan2(this.cross(t).length(),this.dot(t))}flip(){this.x*=-1,this.y*=-1,this.z*=-1}static pointing2Vec3(t){let e=D.sin(t.theta),i=e*D.cos(t.phi),r=e*D.sin(t.phi),s=D.cos(t.theta);return new L(i,r,s)}}class _{constructor(t){let e=t.length;if(e>=2){this.center=t[0].add(t[1]),this.center.normalize(),this.cosrad=t[0].dot(this.center);for(let i=2;i<e;++i)t[i].dot(this.center)<this.cosrad&&this.getCircle(t,i)}else console.log("too few points")}getCircle(t,e){this.center=t[0].add(t[e]),this.center.normalize(),this.cosrad=t[0].dot(this.center);for(let i=1;i<e;++i)t[i].dot(this.center)<this.cosrad&&this.getCircle2(t,i,e)}getCircle2(t,e,i){this.center=t[e].add(t[i]),this.center.normalize(),this.cosrad=t[e].dot(this.center);for(let r=0;r<e;++r)t[r].dot(this.center)<this.cosrad&&(this.center=t[e].sub(t[r]).cross(t[i].sub(t[r])),this.center.normalize(),this.cosrad=t[r].dot(this.center),this.cosrad<0&&(this.center.flip(),this.cosrad=-this.cosrad))}getCenter(){return new L(this.center.x,this.center.y,this.center.z)}getCosrad(){return this.cosrad}}class F{constructor(t,e,i){this.fx=t,this.fy=e,this.face=i,this.jrll=new Uint8Array([2,2,2,2,3,3,3,3,4,4,4,4]),this.jpll=new Uint8Array([1,3,5,7,0,2,4,6,1,3,5,7]),this.halfpi=Math.PI/2}toHploc(){let t,e=new D,i=this.jrll[this.face]-this.fx-this.fy;if(i<1){t=i;let r=t*t/3;e.z=1-r,e.z>.99&&(e.sth=Math.sqrt(r*(2-r)),e.have_sth=!0)}else if(i>3){t=4-i;let r=t*t/3;e.z=r-1,e.z<-.99&&(e.sth=Math.sqrt(r*(2-r)),e.have_sth=!0)}else t=1,e.z=2*(2-i)/3;let r=this.jpll[this.face]*t+this.fx-this.fy;return r<0&&(r+=8),r>=8&&(r-=8),e.phi=t<1e-15?0:.5*this.halfpi*r/t,e}toVec3(){return this.toHploc().toVec3()}}class X{constructor(t){this.p=new Array(t),this.o=new Int32Array(t),this.s=0,this.m=0}push(t,e){this.p[this.s]=t,this.o[this.s]=e,++this.s}pop(){--this.s}popToMark(){this.s=this.m}size(){return this.s}mark(){this.m=this.s}otop(){return this.o[this.s-1]}ptop(){return this.p[this.s-1]}}class z{constructor(t){t<0&&console.error("capacity must be positive"),this.r=new Int32Array(t<<1),this.sz=0}append(t){this.append1(t,t+1)}append1(t,e){if(t>=e)return;if(this.sz>0&&t<=this.r[this.sz-1])return t<this.r[this.sz-2]&&console.error("bad append operation"),void(e>this.r[this.sz-1]&&(this.r[this.sz-1]=e));let i=this.sz+2;if(this.r.length<i){let t=Math.max(2*this.r.length,i),e=new Int32Array(t);e.set(this.r),this.r=e}this.r[this.sz]=t,this.r[this.sz+1]=e,this.sz+=2}ensureCapacity(t){this.r.length<t&&this.resize(Math.max(2*this.r.length,t))}resize(t){if(t<this.sz&&console.error("requested array size too small"),t==this.r.length)return;new Int32Array(t);let e=this.r.slice(0,this.sz+1);this.r=e}}class V{constructor(t,e,i){this.ix=t,this.iy=e,this.face=i}}class H{constructor(t){this.order_max=29,this.inv_halfpi=2/Math.PI,this.twothird=2/3,this.ns_max=Math.pow(2,this.order_max),this.ctab=new Uint16Array([0,1,256,257,2,3,258,259,512,513,768,769,514,515,770,771,4,5,260,261,6,7,262,263,516,517,772,773,518,519,774,775,1024,1025,1280,1281,1026,1027,1282,1283,1536,1537,1792,1793,1538,1539,1794,1795,1028,1029,1284,1285,1030,1031,1286,1287,1540,1541,1796,1797,1542,1543,1798,1799,8,9,264,265,10,11,266,267,520,521,776,777,522,523,778,779,12,13,268,269,14,15,270,271,524,525,780,781,526,527,782,783,1032,1033,1288,1289,1034,1035,1290,1291,1544,1545,1800,1801,1546,1547,1802,1803,1036,1037,1292,1293,1038,1039,1294,1295,1548,1549,1804,1805,1550,1551,1806,1807,2048,2049,2304,2305,2050,2051,2306,2307,2560,2561,2816,2817,2562,2563,2818,2819,2052,2053,2308,2309,2054,2055,2310,2311,2564,2565,2820,2821,2566,2567,2822,2823,3072,3073,3328,3329,3074,3075,3330,3331,3584,3585,3840,3841,3586,3587,3842,3843,3076,3077,3332,3333,3078,3079,3334,3335,3588,3589,3844,3845,3590,3591,3846,3847,2056,2057,2312,2313,2058,2059,2314,2315,2568,2569,2824,2825,2570,2571,2826,2827,2060,2061,2316,2317,2062,2063,2318,2319,2572,2573,2828,2829,2574,2575,2830,2831,3080,3081,3336,3337,3082,3083,3338,3339,3592,3593,3848,3849,3594,3595,3850,3851,3084,3085,3340,3341,3086,3087,3342,3343,3596,3597,3852,3853,3598,3599,3854,3855]),this.utab=new Uint16Array([0,1,4,5,16,17,20,21,64,65,68,69,80,81,84,85,256,257,260,261,272,273,276,277,320,321,324,325,336,337,340,341,1024,1025,1028,1029,1040,1041,1044,1045,1088,1089,1092,1093,1104,1105,1108,1109,1280,1281,1284,1285,1296,1297,1300,1301,1344,1345,1348,1349,1360,1361,1364,1365,4096,4097,4100,4101,4112,4113,4116,4117,4160,4161,4164,4165,4176,4177,4180,4181,4352,4353,4356,4357,4368,4369,4372,4373,4416,4417,4420,4421,4432,4433,4436,4437,5120,5121,5124,5125,5136,5137,5140,5141,5184,5185,5188,5189,5200,5201,5204,5205,5376,5377,5380,5381,5392,5393,5396,5397,5440,5441,5444,5445,5456,5457,5460,5461,16384,16385,16388,16389,16400,16401,16404,16405,16448,16449,16452,16453,16464,16465,16468,16469,16640,16641,16644,16645,16656,16657,16660,16661,16704,16705,16708,16709,16720,16721,16724,16725,17408,17409,17412,17413,17424,17425,17428,17429,17472,17473,17476,17477,17488,17489,17492,17493,17664,17665,17668,17669,17680,17681,17684,17685,17728,17729,17732,17733,17744,17745,17748,17749,20480,20481,20484,20485,20496,20497,20500,20501,20544,20545,20548,20549,20560,20561,20564,20565,20736,20737,20740,20741,20752,20753,20756,20757,20800,20801,20804,20805,20816,20817,20820,20821,21504,21505,21508,21509,21520,21521,21524,21525,21568,21569,21572,21573,21584,21585,21588,21589,21760,21761,21764,21765,21776,21777,21780,21781,21824,21825,21828,21829,21840,21841,21844,21845]),this.jrll=new Int16Array([2,2,2,2,3,3,3,3,4,4,4,4]),this.jpll=new Int16Array([1,3,5,7,0,2,4,6,1,3,5,7]),this.xoffset=new Int16Array([-1,-1,0,1,1,1,0,-1]),this.yoffset=new Int16Array([0,1,1,1,0,-1,-1,-1]),this.facearray=[new Int16Array([8,9,10,11,-1,-1,-1,-1,10,11,8,9]),new Int16Array([5,6,7,4,8,9,10,11,9,10,11,8]),new Int16Array([-1,-1,-1,-1,5,6,7,4,-1,-1,-1,-1]),new Int16Array([4,5,6,7,11,8,9,10,11,8,9,10]),new Int16Array([0,1,2,3,4,5,6,7,8,9,10,11]),new Int16Array([1,2,3,0,0,1,2,3,5,6,7,4]),new Int16Array([-1,-1,-1,-1,7,4,5,6,-1,-1,-1,-1]),new Int16Array([3,0,1,2,3,0,1,2,4,5,6,7]),new Int16Array([2,3,0,1,-1,-1,-1,-1,0,1,2,3])],this.swaparray=[new Int16Array([0,0,3]),new Int16Array([0,0,6]),new Int16Array([0,0,0]),new Int16Array([0,0,5]),new Int16Array([0,0,0]),new Int16Array([5,0,0]),new Int16Array([0,0,0]),new Int16Array([6,0,0]),new Int16Array([3,0,0])],t<=this.ns_max&&t>0&&(this.nside=t,this.npface=this.nside*this.nside,this.npix=12*this.npface,this.order=this.nside2order(this.nside),this.nl2=2*this.nside,this.nl3=3*this.nside,this.nl4=4*this.nside,this.fact2=4/this.npix,this.fact1=(this.nside<<1)*this.fact2,this.ncap=2*this.nside*(this.nside-1)),this.bn=[],this.mpr=[],this.cmpr=[],this.smpr=[]}computeBn(){for(let t=0;t<=this.order_max;++t)this.bn[t]=new H(1<<t),this.mpr[t]=this.bn[t].maxPixrad(),this.cmpr[t]=D.cos(this.mpr[t]),this.smpr[t]=D.sin(this.mpr[t])}getNPix(){return this.npix}getBoundaries(t){let e=new Array,i=this.nest2xyf(t),r=.5/this.nside,s=(i.ix+.5)/this.nside,n=(i.iy+.5)/this.nside;return e[0]=new F(s+r,n+r,i.face).toVec3(),e[1]=new F(s-r,n+r,i.face).toVec3(),e[2]=new F(s-r,n-r,i.face).toVec3(),e[3]=new F(s+r,n-r,i.face).toVec3(),e}getBoundariesWithStep(t,e){let i=new Array,r=this.nest2xyf(t),s=.5/this.nside,n=(r.ix+.5)/this.nside,a=(r.iy+.5)/this.nside,o=1/(this.nside*e);for(let t=0;t<e;t++)i[t]=new F(n+s-t*o,a+s,r.face).toVec3(),i[t+e]=new F(n-s,a+s-t*o,r.face).toVec3(),i[t+2*e]=new F(n-s+t*o,a-s,r.face).toVec3(),i[t+3*e]=new F(n+s,a-s+t*o,r.face).toVec3();return i}getPointsForXyfNoStep(t,e,i){let r=Math.pow(2,this.order),s=new Array,n=new V(t,e,i),a=.5/r,o=(n.ix+.5)/r,l=(n.iy+.5)/r;return s[0]=new F(o+a,l+a,n.face).toVec3(),s[1]=new F(o-a,l+a,n.face).toVec3(),s[2]=new F(o-a,l-a,n.face).toVec3(),s[3]=new F(o+a,l-a,n.face).toVec3(),s}getPointsForXyf(t,e,i,r){let s=i*Math.pow(2,this.order),n=new Array,a=new V(t,e,r),o=.5/s,l=(a.ix+.5)/s,h=(a.iy+.5)/s;return n[0]=new F(l+o,h+o,a.face).toVec3(),n[1]=new F(l-o,h+o,a.face).toVec3(),n[2]=new F(l-o,h-o,a.face).toVec3(),n[3]=new F(l+o,h-o,a.face).toVec3(),n}neighbours(t){let e=new Int32Array(8),i=this.nest2xyf(t),r=i.ix,s=i.iy,n=i.face;var a=this.nside-1;if(r>0&&r<a&&s>0&&s<a){let t=Math.floor(n<<2*this.order),i=this.spread_bits(r),a=this.spread_bits(s)<<1,o=this.spread_bits(r+1),l=this.spread_bits(s+1)<<1,h=this.spread_bits(r-1),c=this.spread_bits(s-1)<<1;e[0]=t+h+a,e[1]=t+h+l,e[2]=t+i+l,e[3]=t+o+l,e[4]=t+o+a,e[5]=t+o+c,e[6]=t+i+c,e[7]=t+h+c}else for(let t=0;t<8;++t){let i=r+this.xoffset[t],a=s+this.yoffset[t],o=4;i<0?(i+=this.nside,o-=1):i>=this.nside&&(i-=this.nside,o+=1),a<0?(a+=this.nside,o-=3):a>=this.nside&&(a-=this.nside,o+=3);let l=this.facearray[o][n];if(l>=0){let r=this.swaparray[o][n>>>2];if((1&r)>0&&(i=Math.floor(this.nside-i-1)),(2&r)>0&&(a=Math.floor(this.nside-a-1)),(4&r)>0){let t=i;i=a,a=t}e[t]=this.xyf2nest(i,a,l)}else e[t]=-1}return e}nside2order(t){return t&t-1?-1:Math.log2(t)}nest2xyf(t){let e=Math.floor(t&this.npface-1);return new V(this.compress_bits(e),this.compress_bits(e>>1),Math.floor(t>>2*this.order))}xyf2nest(t,e,i){return Math.floor(i<<2*this.order)+this.spread_bits(t)+(this.spread_bits(e)<<1)}loc2pix(t){let e,i=t.z,r=t.phi,s=Math.abs(i),n=this.fmodulo(r*this.inv_halfpi,4);if(s<=this.twothird){let t=this.nside*(.5+n),r=this.nside*(.75*i),s=Math.floor(t-r),a=Math.floor(t+r),o=Math.floor(s>>>this.order),l=Math.floor(a>>>this.order),h=Math.floor(o==l?4|o:o<l?o:l+8),c=Math.floor(a&this.nside-1),u=Math.floor(this.nside-(s&this.nside-1)-1);e=this.xyf2nest(c,u,h)}else{let r=Math.min(3,Math.floor(n)),a=n-r,o=s<.99||!t.have_sth?this.nside*Math.sqrt(3*(1-s)):this.nside*t.sth/Math.sqrt((1+s)/3),l=Math.floor(a*o),h=Math.floor((1-a)*o);l>=this.nside&&(l=this.nside-1),h>=this.nside&&(h=this.nside-1),e=i>=0?this.xyf2nest(Math.floor(this.nside-h-1),Math.floor(this.nside-l-1),r):this.xyf2nest(Math.floor(l),Math.floor(h),r+8)}return e}pix2vec(t){return this.pix2loc(t).toVec3()}pix2zphi(t){return this.pix2loc(t).toZphi()}pix2loc(t){let e,i=new D(void 0),r=this.nest2xyf(t),s=(this.jrll[r.face]<<this.order)-r.ix-r.iy-1;if(s<this.nside){e=s;let t=e*e*this.fact2;i.z=1-t,i.z>.99&&(i.sth=Math.sqrt(t*(2-t)),i.have_sth=!0)}else if(s>this.nl3){e=this.nl4-s;let t=e*e*this.fact2;i.z=t-1,i.z<-.99&&(i.sth=Math.sqrt(t*(2-t)),i.have_sth=!0)}else e=this.nside,i.z=(this.nl2-s)*this.fact1;let n=this.jpll[r.face]*e+r.ix-r.iy;return n<0&&(n+=8*e),i.phi=e==this.nside?.75*R.halfpi*n*this.fact1:.5*R.halfpi*n/e,i}ang2pix(t,e){return this.loc2pix(new D(t))}fmodulo(t,e){if(t>=0)return t<e?t:t%e;var i=t%e+e;return i===e?0:i}compress_bits(t){var e=Math.floor(21845&t)|Math.floor((1431633920&t)>>>15);return this.ctab[255&e]|this.ctab[e>>>8]<<4}spread_bits(t){return Math.floor(this.utab[255&t])|Math.floor(this.utab[t>>>8&255]<<16)|Math.floor(this.utab[t>>>16&255]<<32)|Math.floor(this.utab[t>>>24&255]<<48)}queryPolygonInclusive(t,e){let i=0!=e,r=t.length;if(!(r>=3))return void console.log("not enough vertices in polygon");let s=new Array;for(let e=0;e<r;++e)s[e]=L.pointing2Vec3(t[e]);let n=new Array,a=0,o=0,l=!1;for(;o<s.length;){let t=s[o],e=null,i=null;o==s.length-1?(i=s[1],e=s[0]):o==s.length-2?(i=s[0],e=s[o+1]):(e=s[o+1],i=s[o+2]),n[o]=t.cross(e).norm();let r=n[o].dot(i);if(0==o)a=r<0?-1:1,new C(t),l=!1;else{if(a*r<0){new C(e),s.splice(o+1,1),n.splice(o,1),l=!0,o-=1;continue}new C(t),l=!1}n[o].scale(a),o+=1}r=s.length;let h=new Array(i?r+1:r);if(h=h.fill(R.halfpi),i){let t=new _(s);n[r]=t.getCenter(),h[r]=D.acos(t.getCosrad())}return this.queryMultiDisc(n,h,e)}queryMultiDisc(t,e,i){this.computeBn();let r=0!=i,s=t.length;if(s!=e.length)return void console.error("inconsistent input arrays");let n=new z(8),a=0;r&&(Math.pow(2,this.order_max-this.order)>=i||console.error("invalid oversampling factor"),i&i-1&&console.error("oversampling factor must be a power of 2"),a=this.ilog2(i));let o,l,h=this.order+a,c=new Array(h+1);for(o=0;o<=h;++o){c[o]=new Array(s);let t=this.bn[o].maxPixrad();for(l=0;l<s;++l)c[o][l]=new Float64Array(3),c[o][l][0]=e[l]+t>Math.PI?-1:D.cos(e[l]+t),c[o][l][1]=0==o?D.cos(e[l]):c[0][l][1],c[o][l][2]=e[l]-t<0?1:D.cos(e[l]-t)}let u=new X(12+3*h);for(let t=0;t<12;t++)u.push(11-t,0);for(;u.size()>0;){let e=u.ptop(),i=u.otop();u.pop();let a=this.bn[i].pix2vec(e),o=3;for(let e=0;e<s&&o>0;++e){let r=a.dot(t[e]);for(let t=0;t<o;++t)r<c[i][e][t]&&(o=t)}o>0&&this.check_pixel(i,h,o,n,e,u,r)}return n}ilog2(t){let e=Math.max(t,1);return 31-Math.clz32(e)}cosdist_zphi(t,e,i,r){return t*i+D.cos(e-r)*Math.sqrt((1-t*t)*(1-i*i))}check_pixel(t,e,i,r,s,n,a){if(0!=i)if(t<this.order)if(i>=3){let e=2*(this.order-t);r.append1(s<<e,s+1<<e)}else for(let e=0;e<4;++e)n.push(4*s+3-e,t+1);else if(t>this.order)if(i>=2)r.append(s>>>2*(t-this.order)),n.popToMark();else if(t<e)for(let e=0;e<4;++e)n.push(4*s+3-e,t+1);else r.append(s>>>2*(t-this.order)),n.popToMark();else if(i>=2)r.append(s);else if(a)if(this.order<e){n.mark();for(let e=0;e<4;++e)n.push(4*s+3-e,t+1)}else r.append(s)}maxPixrad(){let t=new B(2/3,Math.PI/this.nl4),e=this.convertZphi2xyz(t),i=new L(e[0],e[1],e[2]),r=1-1/this.nside;r*=r;let s=new B(1-r/3,0),n=this.convertZphi2xyz(s),a=new L(n[0],n[1],n[2]);return i.angle(a)}convertZphi2xyz(t){let e=Math.sqrt((1-t.z)*(1+t.z));return[e*D.cos(t.phi),e*D.sin(t.phi),t.z]}queryDiscInclusive(t,e,i){this.computeBn();let r=0!=i,s=new z;if(e>=Math.PI)return s.append1(0,this.npix),s;let n=0;r&&(i&i-1&&console.error("oversampling factor must be a power of 2"),n=this.ilog2(i));let a=Math.min(this.order_max,this.order+n),o=L.pointing2Vec3(t),l=new Array(a+1),h=new Array(a+1),c=D.cos(e),u=D.sin(e);for(let t=0;t<=a;t++){let i=this.mpr[t],r=this.cmpr[t],s=this.smpr[t];l[t]=e+i>Math.PI?-1:c*r-u*s,h[t]=e-i<0?1:c*r+u*s}let d=new X(12+3*a);for(let t=0;t<12;t++)d.push(11-t,0);for(;d.size()>0;){let e=d.ptop(),i=d.otop();d.pop();let n=this.bn[i].pix2zphi(e),u=this.cosdist_zphi(o.z,t.phi,n.z,n.phi);if(u>l[i]){let t=u<c?1:u<=h[i]?2:3;this.check_pixel(i,a,t,s,e,d,r)}}return s}}class O{static setupByTile(t,e){let i={min_y:NaN,max_y:NaN,min_x:NaN,max_x:NaN,gridPointsDeg:[]},r=e.getBoundariesWithStep(t,1),s=[];for(let t=0;t<r.length;t++)if(s[t]=new C(r[t]),t>=1){let e=s[t-1].phi,i=s[t].phi;Math.abs(e-i)>Math.PI&&(s[t-1].phi<s[t].phi?s[t-1].phi+=2*Math.PI:s[t].phi+=2*Math.PI)}for(let t=0;t<s.length;t++){let e=s[t].theta,r=Math.PI/2-e,n=s[t].phi,a=new M(c.ASTRO,h.RADIANS,n,r),o=O.world2intermediate(a.getAstro());i.gridPointsDeg[2*t]=o[0],i.gridPointsDeg[2*t+1]=o[1],(isNaN(i.max_y)||o[1]>i.max_y)&&(i.max_y=o[1]),(isNaN(i.min_y)||o[1]<i.min_y)&&(i.min_y=o[1]),(isNaN(i.max_x)||o[0]>i.max_x)&&(i.max_x=o[0]),(isNaN(i.min_x)||o[0]<i.min_x)&&(i.min_x=o[0])}return i}static world2intermediate(t){let e=NaN,i=NaN;if(Math.abs(t.decRad)<=O.THETAX)e=t.raDeg,i=D.sin(t.decRad)*O.K*90/O.H;else if(Math.abs(t.decRad)>O.THETAX){let r=t.raDeg,s=0;(O.K%2!=0||t.decRad>0)&&(s=1);let n=Math.sqrt(O.K*(1-Math.abs(D.sin(t.decRad)))),a=(2*Math.floor((t.raDeg+180)*O.H/360+(1-s)/2)+s)*(180/O.H)-180;e=a+(r-a)*n,i=180/O.H*((O.K+1)/2-n),t.decRad<0&&(i*=-1)}return[e,i]}static intermediate2pix(t,e,i,r){let s,n,a=Math.abs(i.max_x-i.min_x),o=Math.abs(i.max_y-i.min_y);s=(i.min_x>360||i.max_x>360)&&t<i.min_x?(t+360-i.min_x)/a:(t-i.min_x)/a,n=(e-i.min_y)/o;let l=.5-(s-n),h=s+n-.5;return l=Math.floor(l*r),h=Math.floor(h*r),[l,r-h-1]}static pix2intermediate(t,e,i,r,s){let n=r,a=s;r&&(n=r),s&&(a=s);const o=(t+.5)/n,l=(e+.5)/a,h=Math.abs(i.max_x-i.min_x)/2,c=Math.abs(i.max_y-i.min_y)/2,u=(i.max_y+i.min_y)/2;return[i.max_x-h*(o+l),u-c*(l-o)]}static intermediate2world(t,e){let i=NaN,r=NaN;const s=90*(O.K-1)/O.H;if(Math.abs(e)<=s)i=t,r=A(Math.asin(e*O.H/(90*O.K)));else if(Math.abs(e)>s){const s=(O.K+1)/2-Math.abs(e*O.H)/180,n=D.asin(1-s*s/O.K);let a=0;(O.K%2!=0||n>0)&&(a=1);const o=(2*Math.floor((t+180)*O.H/360+(1-a)/2)+a)*(180/O.H)-180;i=o+(t-o)/s,r=A(n),e<=0&&(r*=-1)}return new M(c.ASTRO,h.DEGREES,i,r)}}O.RES_ORDER_0=58.6,O.H=4,O.K=3,O.THETAX=D.asin((O.K-1)/O.K);class j{static computeOrder(t,e){console.log(`Computing HiPS order having pixel angular size of ${t} in degrees`);const i=t*(Math.PI/180);console.log(`pixel angular res in radians ${i}`);const r=.5*Math.log2(Math.PI/(3*i*i*e*e));return console.log(`Order ${r}`),r<0?0:Math.floor(r)}static getHelpixByOrder(t){const e=Math.pow(2,t);return new H(e)}static getHelpixBypxAngSize(t,e){const i=j.computeOrder(t,e),r=Math.pow(2,i);return new H(r)}static computePxAngularSize(t,e){const i=Math.sqrt(4*Math.PI/(12*Math.pow(t*Math.pow(2,e),2)));console.log(`Computing Pixel size with tile of ${t} pixels and order ${e}`);const r=180/Math.PI,s=i*r,n=i*r*60,a=i*r*3600;return console.log("Pixel size in radiant:"+i),console.log("Pixel size in degrees:"+s),console.log("Pixel size in arcmin:"+n),console.log("Pixel size in arcsec:"+a),{rad:i,deg:s,arcmin:n,arcsec:a}}static computePxSize(t,e){return 1/(e*Math.pow(2,t))*Math.sqrt(Math.PI/3)}static computeBbox(t,e){let i=[];return i.push(new C(null,!1,t.getSpherical().thetaRad-e,t.getSpherical().phiRad-e)),i.push(new C(null,!1,t.getSpherical().thetaRad-e,t.getSpherical().phiRad+e)),i.push(new C(null,!1,t.getSpherical().thetaRad+e,t.getSpherical().phiRad+e)),i.push(new C(null,!1,t.getSpherical().thetaRad-e,t.getSpherical().phiRad-e)),i}}j.DEFAULT_Naxis1_2=512,j.RES_ORDER_0=58.6,j.H=4,j.K=3,j.THETAX=D.asin((j.K-1)/j.K);class k{constructor(){this.itemMap=new Map}addItem(t,e){this.itemMap.set(t,e)}getItem(t){return this.itemMap.get(t)}isGalactic(){return this.itemMap.get(k.FRAME)==k.GALACTIC}}k.TILE_WIDTH="hips_tile_width",k.FRAME="hips_frame",k.ORDER="hips_order",k.GALACTIC="galactic",k.SCALE="hips_pixel_scale",k.BITPIX="hips_pixel_bitpix";class ${constructor(t,e,i){if(this.payload=[],this.min=NaN,this.max=NaN,t)this.initFromFITSParsed(t);else{if(!e||!i)throw console.error("tileno or hipsProp are not defined"),new Error("tileno or hipsProp are not defined");{this.order=i.getItem(k.ORDER);const t=i.getItem(k.TILE_WIDTH),r=i.getItem(k.TILE_WIDTH);if(this.tileno=e,t!=r)throw console.error("NAXIS1 and NAXIS2 do not match."),new Error("NAXIS1 and NAXIS2 do not match.");this.tileWidth=t,this.tileno=e,this.healpix=j.getHelpixByOrder(this.order),this.intermediateXYGrid=O.setupByTile(this.tileno,this.healpix)}}}initFromUint8Array(t,e,i){this.setPayload(t,e,i),this.setHeader(e)}getHeader(){return this.header}getPayload(){return this.payload}initFromFITSParsed(t){var i,r,s,n;this.payload=t.data,this.order=Number(null===(i=t.header.findById(k.ORDER))||void 0===i?void 0:i.value);const a=Number(null===(r=t.header.findById(e.NAXIS1))||void 0===r?void 0:r.value),o=Number(null===(s=t.header.findById(e.NAXIS2))||void 0===s?void 0:s.value);if(this.tileno=Number(null===(n=t.header.findById($.NPIX))||void 0===n?void 0:n.value),isNaN(this.order)||isNaN(a)||isNaN(o)||isNaN(this.tileno))throw console.warn("ORDER, NAXIS1 or NAXIS2 not defined"),new Error("ORDER, NAXIS1 or NAXIS2 not defined");if(a!=o)throw console.error("NAXIS1 and NAXIS2 do not match."),new Error("NAXIS1 and NAXIS2 do not match.");this.tileWidth=a,this.computeMinMax(t),this.setHeader(t.header)}getTileno(){return this.tileno}computeMinMax(t){var i,r,s;const n=Number(null===(i=t.header.findById(e.BITPIX))||void 0===i?void 0:i.value),a=Number(null===(r=t.header.findById(e.BZERO))||void 0===r?void 0:r.value),l=Number(null===(s=t.header.findById(e.BSCALE))||void 0===s?void 0:s.value),h=Math.abs(n/8);for(let e=0;e<t.data.length;e++){const i=t.data[e];for(let t=0;t<i.length;t++){const i=o.extractPixelValue(0,this.payload[e].slice(t*h,t*h+h),n);if(null==i)continue;const r=a+l*i;r<this.min||isNaN(this.min)?this.min=r:(r>this.max||isNaN(this.max))&&(this.max=r)}}}static downloadFITSFile(t){return e=this,i=void 0,s=function*(){const e=yield d.loadFITS(t);return null==e?(console.warn(`fits ${t} doesn't exist`),null):e},new((r=void 0)||(r=Promise))((function(t,n){function a(t){try{l(s.next(t))}catch(t){n(t)}}function o(t){try{l(s.throw(t))}catch(t){n(t)}}function l(e){var i;e.done?t(e.value):(i=e.value,i instanceof r?i:new r((function(t){t(i)}))).then(a,o)}l((s=s.apply(e,i||[])).next())}));var e,i,r,s}getFITS(){return{header:this.header,data:this.payload}}setPayload(t,i,r){var s,n,a;const l=Number(null===(s=i.findById(e.BITPIX))||void 0===s?void 0:s.value),c=Number(null===(n=i.findById(e.BZERO))||void 0===n?void 0:n.value),u=Number(null===(a=i.findById(e.BSCALE))||void 0===a?void 0:a.value),d=Math.abs(l/8);if(!d)throw console.error("BITPIX not defined"),new Error("BITPIX not defined");this.payload=new Array(r);for(let t=0;t<r;t++)this.payload[t]=new Uint8Array(r*d);t.forEach((t=>{const e=t.getRADeg(),i=t.getDecDeg(),s=y(e,i,h.DEGREES);if(null==s)return void console.error(`Error converting ${e}, ${i} into AstroCoords object`);const n=O.world2intermediate(s),[a,p]=O.intermediate2pix(n[0],n[1],this.intermediateXYGrid,r);if(p<0||p>=r||a<0||a>=r)return;const f=t.getUint8Value();if(!f)return;for(let t=0;t<d;t++)this.payload[p][a*d+t]=f[t];const g=o.extractPixelValue(0,f,l);if(null==g)return;const m=c+u*g;(isNaN(this.min)||m<this.min)&&(this.min=m),(isNaN(this.max)||m>this.max)&&(this.max=m)}))}addMandatoryItemToHeader(e,i){var r;const s=null===(r=i.findById(e))||void 0===r?void 0:r.value;if(void 0===s||null==s)throw console.error(`${e} not defined`),new Error(e+" is not defined");const n=new t(e,s,"");this.header.insert(n)}addItemToHeader(e,i){var r;const s=null===(r=i.findById(e))||void 0===r?void 0:r.value;if(void 0!==s||null!=s){const i=new t(e,s,"");this.header.insert(i)}}setHeader(i){this.header=new e,this.addMandatoryItemToHeader(e.SIMPLE,i),this.addMandatoryItemToHeader(e.BITPIX,i),this.addItemToHeader(e.BLANK,i),this.addItemToHeader(e.BSCALE,i),this.addItemToHeader(e.BZERO,i),this.header.insert(new t(e.NAXIS,Number(2),"")),this.header.insert(new t(e.NAXIS1,Number(this.tileWidth),"")),this.header.insert(new t(e.NAXIS2,Number(this.tileWidth),"")),this.header.insert(new t(e.CTYPE1,$.CTYPE1,"")),this.header.insert(new t(e.CTYPE2,$.CTYPE2,"")),this.header.insert(new t(e.DATAMIN,this.min,"")),this.header.insert(new t(e.DATAMAX,this.min,"")),this.header.insert(new t(k.ORDER,Number(this.order),"")),this.header.insert(new t($.NPIX,Number(this.tileno),""));const r=this.tileno/2;this.header.insert(new t(e.CRPIX1,r,"")),this.header.insert(new t(e.CRPIX2,r,"")),this.header.insert(new t(e.ORIGIN,"WCSLight v.0.x","")),this.header.insert(new t(e.COMMENT,"","WCSLight v0.x developed by F.Giordano and Y.Ascasibar"));let s=this.healpix.pix2vec(this.tileno),n=new C(s),a=A(n.phi),o=90-A(n.theta);this.header.insert(new t(e.CRVAL1,a,"")),this.header.insert(new t(e.CRVAL2,o,"")),this.header.insert(new t("END","",""))}}$.CTYPE1="RA---HPX",$.CTYPE2="DEC--HPX",$.NPIX="NPIX";class K{constructor(){this.fitslist=new Map}getFITSList(){return this.fitslist}getFITS(t){const e=this.fitslist.get(t);return void 0===e?null:e}addFITSByURL(t){return e=this,i=void 0,s=function*(){const e=yield d.loadFITS(t),i=new $(e,null,null);this.fitslist.set(i.getTileno(),i)},new((r=void 0)||(r=Promise))((function(t,n){function a(t){try{l(s.next(t))}catch(t){n(t)}}function o(t){try{l(s.throw(t))}catch(t){n(t)}}function l(e){var i;e.done?t(e.value):(i=e.value,i instanceof r?i:new r((function(t){t(i)}))).then(a,o)}l((s=s.apply(e,i||[])).next())}));var e,i,r,s}addFITS(t){const e=t.getTileno();this.fitslist.set(e,t)}}var U=s(942),Z=function(t,e,i,r){return new(i||(i=Promise))((function(s,n){function a(t){try{l(r.next(t))}catch(t){n(t)}}function o(t){try{l(r.throw(t))}catch(t){n(t)}}function l(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}l((r=r.apply(t,e||[])).next())}))};class q{static parsePropertyFile(t){return Z(this,void 0,void 0,(function*(){let e="";return e=t.includes("http")?yield q.getPorpertyFromWeb(t):yield q.getPorpertyFromFS(t),q.parseHiPSPropertiesBody(e)}))}static getPorpertyFromWeb(t){return Z(this,void 0,void 0,(function*(){const e=yield fetch(t+"/properties");if(e.ok)return yield e.text();throw new Error(`HTTP error! Status: ${e.status}`)}))}static getPorpertyFromFS(t){return Z(this,void 0,void 0,(function*(){const e=t+"/properties",i=yield(0,U.readFile)(e),r=new Uint8Array(i);return new TextDecoder("ascii").decode(r)}))}static parseHiPSPropertiesBody(t){let e=new k;const i=t.split("\n");for(let t of i){if(!t.includes("="))continue;const i=t.split("=");if(void 0===i[1])continue;const r=i[0].trim(),s=i[1].trim();let n=s;r!=k.ORDER&&r!=k.TILE_WIDTH&&r!=k.SCALE&&r!=k.BITPIX||(n=parseInt(s)),e.addItem(r,n)}return e}}var G=function(t,e,i,r){return new(i||(i=Promise))((function(s,n){function a(t){try{l(r.next(t))}catch(t){n(t)}}function o(t){try{l(r.throw(t))}catch(t){n(t)}}function l(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}l((r=r.apply(t,e||[])).next())}))};class W{constructor(t){if(this.healpix=null,this.hipsProp=null,this.baseURL=t,this.init(),null==this.healpix)throw console.warn("healpix is null"),new Error("healpix is null");if(null==this.hipsProp)throw console.warn("HiPSProp is null"),new Error("HiPSProp is null")}init(){return G(this,void 0,void 0,(function*(){const t=(yield this.parsePropertyFile()).getItem(k.ORDER);this.healpix=j.getHelpixByOrder(t)}))}parsePropertyFile(){return G(this,void 0,void 0,(function*(){return q.parsePropertyFile(this.baseURL)}))}static getImageRADecList(t,e,i,r){const s=j.getHelpixBypxAngSize(i,r);let n=new N;const a=new C(null,!1,t.getSpherical().thetaRad,t.getSpherical().phiRad),o=x(e),l=s.queryDiscInclusive(a,o,4);for(let t=0;t<l.r.length;t++)n.getTilesList().includes(l.r[t])||0==l.r[t]||n.addTileNumber(l.r[t]);const h=s.ang2pix(a);n.getTilesList().includes(h)||n.getTilesList().push(h);let c=t.getAstro().raDeg-e,u=t.getAstro().raDeg+e,d=t.getAstro().decDeg-e,p=t.getAstro().decDeg+e;return n.getTilesList().forEach((t=>{for(let e=0;e<r;e++)for(let i=0;i<r;i++){const a=W.pix2world(i,e,t,s,r);null!=a&&(a.getAstro().raDeg<c||a.getAstro().raDeg>u||a.getAstro().decDeg<d||a.getAstro().decDeg>p||n.addImagePixel(new T(a.getAstro().raDeg,a.getAstro().decDeg,t)))}})),n}static pix2world(t,e,i,r,s){let n=null;if(!r)throw new Error("Healpix not set.");{const a=O.setupByTile(i,r);let o=O.pix2intermediate(t,e,a,s,s);n=O.intermediate2world(o[0],o[1])}return n}static getFITSFiles(t,e,i,r){const s=j.getHelpixBypxAngSize(i,r);let n=new K;return t.getTilesList().forEach((i=>{let a=new k;a.addItem(k.ORDER,s.order),a.addItem(k.TILE_WIDTH,r);const o=new $(null,i,a),l=t.getImagePixelsByTile(i);o.initFromUint8Array(l,e,r),n.addFITS(o)})),n}static world2pix(t,e,i,r,s){return G(this,void 0,void 0,(function*(){const n=j.getHelpixByOrder(e);let a,o=null;i&&W.convertToGalactic(t);let l=null;return t.getImagePixelList().forEach((e=>{const i=e.getRADeg(),s=e.getDecDeg(),u=new M(c.ASTRO,h.DEGREES,i,s),d=new C(null,!1,u.getSpherical().thetaRad,u.getSpherical().phiRad);if(a=n.ang2pix(d),o===a&&null!=o||(l=O.setupByTile(a,n),o=a),l){const t=O.world2intermediate(u.getAstro()),i=O.intermediate2pix(t[0],t[1],l,r);e.setij(i[0],i[1]),e.setTileNumber(a)}t.addTileNumber(a)})),yield W.getPixelValues(t,s,e)}))}static convertToGalactic(t){const e=Math.PI/180,i=180/Math.PI,r=122.93*e,s=27.1284*e,n=192.8595*e;t.getImagePixelList().forEach((t=>{const a=t.getRADeg(),o=t.getDecDeg(),l=e*a,h=e*o,c=Math.sin(s)*Math.sin(h)+Math.cos(s)*Math.cos(h)*Math.cos(l-n),u=Math.asin(c)*i,d=Math.atan(Math.cos(h)*Math.sin(l-n)/(Math.sin(h)*Math.cos(s)-Math.cos(h)*Math.sin(s)*Math.cos(l-n))),p=(r-d)*i;t.setRADecDeg(p,u)}))}static getPixelValues(t,e,i){return G(this,void 0,void 0,(function*(){const r=t.getTilesList();let s=[];for(let n of r){const r=1e4*Math.floor(n/1e4),a=e+"/Norder"+i+"/Dir"+r+"/Npix"+n+".fits";console.log(`Identified source file ${a}`),s.push(d.loadFITS(a).then((e=>{var i,r,s,o,l,h;if(e){const c=Number(null===(i=e.header.findById("BITPIX"))||void 0===i?void 0:i.value),u=Number(null===(r=e.header.findById("NAXIS1"))||void 0===r?void 0:r.value),d=Number(null===(s=e.header.findById("NAXIS2"))||void 0===s?void 0:s.value);if(!c||!u||!d)return void console.error(`bitpix: ${c}, naxis1: ${u}, naxis2: ${d} for fits file ${a}`);if(null==t.getBLANK()){const i=null===(o=e.header.findById("BLANK"))||void 0===o?void 0:o.value;if(i){const e=Number(i);isNaN(e)||t.setBLANK(e)}}if(null==t.getBSCALE()){const i=null===(l=e.header.findById("BSCALE"))||void 0===l?void 0:l.value;if(i){const e=Number(i);isNaN(e)||t.setBSCALE(e)}}if(null==t.getBZERO()){const i=null===(h=e.header.findById("BZERO"))||void 0===h?void 0:h.value;if(i){const e=Number(i);isNaN(e)||t.setBZERO(e)}}const p=Math.abs(c/8);t.getImagePixelsByTile(n).forEach((i=>{const r=new Uint8Array(p);for(let t=0;t<p;t++)r[t]=e.data[i.getj()][i.geti()*p+t];i.setValue(r,c),t.setMinMaxValue(i.getValue())}))}})))}return yield Promise.all(s),null==t.getBSCALE()&&t.setBSCALE(1),null==t.getBZERO()&&t.setBZERO(0),null==t.getBLANK()&&t.setBLANK(0),t}))}}var Y=function(t,e,i,r){return new(i||(i=Promise))((function(s,n){function a(t){try{l(r.next(t))}catch(t){n(t)}}function o(t){try{l(r.throw(t))}catch(t){n(t)}}function l(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}l((r=r.apply(t,e||[])).next())}))};class J{static fitsCutoutToHiPS(t,e,i,r){return Y(this,void 0,void 0,(function*(){const s=yield J.extractProjectionType(r);if(!s)return null;const n=W.getImageRADecList(t,e,i,512);if(!n)return null;s.world2pix(n);const a=W.getFITSFiles(n,s.getFITSHeader(),i,512);for(let t of a.getFITSList()){const e=t[0],i=t[1],r=i.getPayload(),s=`./hips_${e}.fits`,n={header:i.getHeader(),data:r};d.saveFITSLocally(n,s)}return a}))}static extractProjectionType(t){return Y(this,void 0,void 0,(function*(){var e;let i=yield d.loadFITS(t);if(!i)return null;if(String(null===(e=i.header.findById("CTYPE1"))||void 0===e?void 0:e.value).includes("MER")){let e=new b;return yield e.initFromFile(t),e}return null}))}static hipsCutoutToFITS(t,e,i,r,s){return Y(this,arguments,void 0,(function*(t,e,i,r,s,n=null){var a,o;const l=yield q.parsePropertyFile(r),h=l.getItem(k.ORDER),c=l.getItem(k.FRAME),u=l.getItem(k.TILE_WIDTH);let p=!1;if("galactic"==c.toLowerCase()&&(p=!0),!n){const t=j.getHelpixBypxAngSize(i,u);n=Number(t.order)}if(n>h)throw new Error("requested HiPS order exceeds the maximum HiPS order ");const f=s.computeNaxisWidth(e,i),g=s.getImageRADecList(t,e,i,f);if(!g)return null;const m=g.computeRADecMinMaxCentral(),I=null==m?void 0:m.getCentralRA(),y=null==m?void 0:m.getCentralDec();if(void 0===I||void 0===y)return null;const w=yield W.world2pix(g,n,p,u,r);if(!w)return null;const x=null===(a=w.getMinMaxValues())||void 0===a?void 0:a.getMinValue(),A=null===(o=w.getMinMaxValues())||void 0===o?void 0:o.getMaxValue();if(void 0===x||void 0===A)return null;const v=w.getBLANK(),M=w.getBZERO(),P=w.getBSCALE();if(null===v||null===M||null===P)return null;console.log(`BLANK: ${v}, BZERO: ${M}, BSCALE: ${P}`);const S=parseInt(l.getItem(k.BITPIX));if(8!=S&&16!=S&&32!=S&&-32!=S&&-64!=S)throw new Error("unsupported BITPIX value");const N=s.generateFITSFile(i,l.getItem(k.BITPIX),f,v,M,P,I,y,x,A,w);console.log(N);const T={header:N.getHeader(),data:N.getData()};return d.saveFITSLocally(T,"./cartesian2.fits"),N}))}static hipsFITSChangeProjection(){return null}static generateFITS(t,e){const i={header:t,data:e};return d.generateFITSForWeb(i)}static getProjection(t){return"Mercator"===t?new b:null}static getAvaillableProjections(){return["Mercator","HiPS","HEALPix"]}}const Q=new M(c.ASTRO,h.DEGREES,170.015,18.35);J.fitsCutoutToHiPS(Q,.06,5e-4,"/Users/fgiordano/Desktop/REORG/PhD/code/github/wcslight/test/output/UC3/3_0/Mercator46.fits").then((t=>{console.log(t)}));class tt{constructor(t,e,i=NaN){this._i=t,this._j=e,this._tileno=i}geti(){return this._i}getj(){return this._j}get tileno(){return this._tileno}}})(),n})()));
//# sourceMappingURL=wcslight.min.js.map